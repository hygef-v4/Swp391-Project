<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" data-bs-theme="light">

<head>
    <title>Khách Hàng Của Tôi - Hamora</title>

    <!-- Meta Tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Quản lý khách hàng - Xem và liên hệ với khách hàng của bạn">

    <!-- Dark mode script (required for header) -->
    <script>
        const storedTheme = localStorage.getItem('theme')
        const getPreferredTheme = () => {
            if (storedTheme) { return storedTheme }
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
        }
        const setTheme = function (theme) {
            if (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.setAttribute('data-bs-theme', 'dark')
            } else {
                document.documentElement.setAttribute('data-bs-theme', theme)
            }
        }
        setTheme(getPreferredTheme())
        window.addEventListener('DOMContentLoaded', () => {
            var el = document.querySelector('.theme-icon-active');
            if (el != 'undefined' && el != null) {
                const showActiveTheme = theme => {
                    const activeThemeIcon = document.querySelector('.theme-icon-active use')
                    const btnToActive = document.querySelector(`[data-bs-theme-value="${theme}"]`)
                    const svgOfActiveBtn = btnToActive.querySelector('.mode-switch use').getAttribute('href')
                    document.querySelectorAll('[data-bs-theme-value]').forEach(element => element.classList.remove('active'))
                    btnToActive.classList.add('active')
                    activeThemeIcon.setAttribute('href', svgOfActiveBtn)
                }
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                    if (storedTheme !== 'light' || storedTheme !== 'dark') { setTheme(getPreferredTheme()) }
                })
                showActiveTheme(getPreferredTheme())
                document.querySelectorAll('[data-bs-theme-value]').forEach(toggle => {
                    toggle.addEventListener('click', () => {
                        const theme = toggle.getAttribute('data-bs-theme-value')
                        localStorage.setItem('theme', theme)
                        setTheme(theme)
                        showActiveTheme(theme)
                    })
                })
            }
        })
    </script>
    <!-- Favicon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico">

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&amp;family=Poppins:wght@400;500;700&amp;display=swap">

    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- Vietnamese Locale -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vn.js"></script>


    <!-- Plugins CSS -->


    <link rel="stylesheet" type="text/css" href="/assets/vendor/font-awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/assets/vendor/bootstrap-icons/bootstrap-icons.css">
    <link rel="stylesheet" type="text/css" href="/assets/vendor/tiny-slider/tiny-slider.css">
    <link rel="stylesheet" type="text/css" href="/assets/vendor/glightbox/css/glightbox.css">
    <link rel="stylesheet" type="text/css" href="/assets/vendor/flatpickr/css/flatpickr.min.css">
    <link rel="stylesheet" type="text/css" href="/assets/vendor/choices/css/choices.min.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
          integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer"/>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"/>

    <!-- Tiny Slider -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tiny-slider/2.9.4/tiny-slider.css"
          integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer"/>

    <!-- Glightbox -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css"/>

    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"/>

    <!-- Choices.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>


    <!-- Theme CSS -->
    <link rel="stylesheet" type="text/css" href="/assets/css/style.css">
    <!-- Favicon -->
    <link rel="shortcut icon" href="assets/images/favicon.ico">

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">

    <!-- Plugins CSS -->
    <link rel="stylesheet" type="text/css" href="assets/vendor/bootstrap-icons/bootstrap-icons.css">

    <!-- Theme CSS -->
    <link rel="stylesheet" type="text/css" href="assets/css/style.css">

    <style>
        :root {
            --primary-accent: #6366f1;
            --primary-gradient: linear-gradient(100deg, #8b5cf6, #ec4899);
            --green-accent: #22c55e;
            --blue-accent: #3b82f6;
            --border-radius-xl: 24px;
            --border-radius-lg: 16px;
            --border-radius-md: 12px;
        }

        [data-bs-theme="light"] {
            --body-bg: #f8f9fa;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #4b5563;
        }

        [data-bs-theme="dark"] {
            --body-bg: #121212;
            --card-bg: #1e1e1e;
            --border-color: #3a3a40;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
        }

        body { background-color: var(--body-bg); color: var(--text-primary); font-family: 'Poppins', sans-serif; }

        .page-header h1 { font-weight: 700; color: var(--text-primary); }
        .page-header p { color: var(--text-secondary); }
        .btn-back-dashboard { background: var(--primary-accent); color: white; border: none; padding: 10px 24px; border-radius: 50px; text-decoration: none; font-weight: 500; transition: all 0.3s ease; }
        .btn-back-dashboard:hover { background-color: #4f46e5; transform: translateY(-2px); }

        .stat-card-total { background-color: var(--card-bg); padding: 24px; border-radius: var(--border-radius-lg); border: 1px solid var(--border-color); box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.05); display: flex; align-items: center; gap: 20px; }
        .stat-card-total .icon-box { width: 60px; height: 60px; display: grid; place-items: center; background-color: rgba(99, 102, 241, 0.1); border-radius: var(--border-radius-md); }
        .stat-card-total .icon-box .bi { font-size: 2rem; color: var(--primary-accent); }
        .stat-card-total .stat-number { font-size: 2.5rem; font-weight: 700; line-height: 1; color: var(--text-primary); }
        .stat-card-total .stat-label { font-size: 1rem; font-weight: 500; color: var(--text-secondary); }

        .form-control, .form-select { background-color: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 12px 20px; border-radius: var(--border-radius-md); height: 50px; transition: all 0.2s ease-in-out; }
        .form-control::placeholder { color: var(--text-secondary); }
        .form-control:focus, .form-select:focus { background-color: var(--card-bg); border-color: var(--primary-accent); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); color: var(--text-primary); }
        .search-wrapper { position: relative; }
        .search-wrapper .bi-search { position: absolute; top: 50%; left: 20px; transform: translateY(-50%); color: var(--text-secondary); }
        .search-wrapper .form-control { padding-left: 50px; }

        .customer-card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius-xl); padding: 24px; transition: all 0.3s ease; height: 100%; display: flex; flex-direction: column; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07); }
        .customer-card:hover { transform: translateY(-5px); border-color: var(--primary-accent); }
        .customer-avatar { width: 60px; height: 60px; object-fit: cover; border-radius: 50%; }
        .customer-info { flex-grow: 1; }
        .customer-card .card-title { font-weight: 600; color: var(--text-primary); text-decoration: none; }
        .customer-card .card-title:hover { color: var(--primary-accent); }
        .customer-card .card-text { color: var(--text-secondary); font-size: 0.875rem; }
        .customer-stat-badge { display: inline-flex; align-items: center; gap: 8px; padding: 6px 14px; border-radius: 50px; font-size: 0.8rem; font-weight: 500; }
        .badge-bookings { background-color: rgba(99, 102, 241, 0.1); color: var(--primary-accent); }
        .badge-spent { background-color: rgba(34, 197, 94, 0.1); color: #166534; }
        [data-bs-theme="dark"] .badge-spent { color: var(--green-accent); }
        .btn-customer-action { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 50px; font-size: 0.875rem; font-weight: 500; border: none; transition: all 0.2s ease-in-out; text-decoration: none; }
        .btn-view-details { background-color: var(--blue-accent); color: white; }
        .btn-view-details:hover { background-color: #1d4ed8; color: white; transform: translateY(-2px); }
        .btn-contact { background-color: var(--green-accent); color: white; }
        .btn-contact:hover { background-color: #16a34a; color: white; transform: translateY(-2px); }
        .no-customers-found { text-align: center; padding: 80px 20px; color: var(--text-secondary); }
        .no-customers-found i { font-size: 4rem; margin-bottom: 20px; opacity: 0.3; }
    </style>
</head>

<body>
<div th:replace="~{common/header :: header}"></div>

<!-- **************** MAIN CONTENT START **************** -->
<main>
    <section th:replace="~{common-host/menu-host :: menu}"></section>

    <section class="pt-0">
        <div class="container vstack gap-4">

            <div class="page-header d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="fs-2 mb-1 d-flex align-items-center gap-3">
                        <i class="bi bi-people-fill text-primary"></i> Khách Hàng Của Tôi
                    </h1>
                    <p class="mb-0">Quản lý và liên hệ với khách hàng đã đặt phòng tại khách sạn của bạn</p>
                </div>
                <a href="/host-dashboard" class="btn-back-dashboard d-none d-md-inline-flex">
                    <i class="bi bi-arrow-left"></i> Về Dashboard
                </a>
            </div>

            <div class="row g-4">
                <div class="col-md-5 col-lg-4">
                    <div class="stat-card-total">
                        <div class="icon-box">
                            <i class="bi bi-people-fill"></i>
                        </div>
                        <div>
                            <h3 class="stat-number" th:text="${totalCustomers}">3</h3>
                            <p class="stat-label mb-0">Tổng Khách Hàng</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3 search-filter-row">
                <div class="col-lg-6">
                    <div class="search-wrapper">
                        <i class="bi bi-search"></i>
                        <input type="text" id="customerSearch" class="form-control" placeholder="Tìm kiếm khách hàng theo tên hoặc email...">
                    </div>
                </div>
                <div class="col-lg-3">
                    <select id="sortBy" class="form-select">
                        <option value="name" selected>Sắp xếp theo tên</option>
                        <option value="bookings">Theo số đơn đặt</option>
                        <option value="revenue">Theo doanh thu</option>
                    </select>
                </div>
            </div>

            <div class="row g-4" id="customer-list">
                <div th:each="customer : ${customers}" class="col-md-6 col-lg-4 customer-item"
                     th:attr="data-name=${customer.user.fullName}, data-email=${customer.user.email}, data-bookings=${customer.totalBookings}, data-revenue=${customer.totalSpent}">
                    <div class="customer-card">
                        <div class="customer-info">
                            <div class="d-flex align-items-center mb-3">
                                <img th:src="${customer.user.avatarUrl ?: 'https://ui-avatars.com/api/?name=' + customer.user.fullName + '&background=8b5cf6&color=fff&rounded=true'}"
                                     alt="Avatar" class="customer-avatar me-3">
                                <div class="flex-grow-1">
                                    <h5 class="mb-0">
                                        <!-- FIX: Removed "stretched-link" class to prevent the whole card from being clickable -->
                                        <a th:href="@{/host-customer-detail(customerId=${customer.user.id})}"
                                           th:text="${customer.user.fullName}" class="card-title">Tên Khách Hàng</a>
                                    </h5>
                                    <p class="card-text mb-0" th:text="${customer.user.email}">customer@example.com</p>
                                </div>
                            </div>
                            <div class="d-flex gap-2 my-4">
                                <span class="customer-stat-badge badge-bookings">
                                    <i class="bi bi-journal-bookmark"></i>
                                    <span th:text="${customer.totalBookings}">0</span> Đơn đặt
                                </span>
                                <span class="customer-stat-badge badge-spent">
                                    <i class="bi bi-cash-coin"></i>
                                    <span th:text="${#numbers.formatDecimal(customer.totalSpent, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0 ₫</span>
                                </span>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end gap-2 mt-auto">
                            <a th:href="@{/host-customer-detail(customerId=${customer.user.id})}" class="btn-customer-action btn-view-details">
                                <i class="bi bi-eye"></i> Xem Chi Tiết
                            </a>
                        </div>
                    </div>
                </div>
                <div id="no-customers-message" class="col-12 d-none">
                    <div class="no-customers-found">
                        <i class="bi bi-person-x"></i>
                        <h4>Không tìm thấy khách hàng nào</h4>
                        <p>Vui lòng thử tìm kiếm với từ khóa khác.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>
<!-- **************** MAIN CONTENT END **************** -->

<div th:replace="~{common/footer :: footer}"></div>

<!-- Core Bootstrap JS -->
<script src="assets/vendor/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<!-- Theme Functions -->
<script src="assets/js/functions.js"></script>

<!-- Optimized Search/Sort Script -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('customerSearch');
        const sortSelect = document.getElementById('sortBy');
        const customerList = document.getElementById('customer-list');
        const noResultsMessage = document.getElementById('no-customers-message');
        const allCustomerItems = Array.from(customerList.querySelectorAll('.customer-item'));

        function debounce(func, delay = 300) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function updateCustomerView() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const sortBy = sortSelect.value;
            let visibleItems = [];
            allCustomerItems.forEach(item => {
                const name = (item.dataset.name || '').toLowerCase();
                const email = (item.dataset.email || '').toLowerCase();
                const isVisible = name.includes(searchTerm) || email.includes(searchTerm);
                item.style.display = isVisible ? '' : 'none';
                if (isVisible) {
                    visibleItems.push(item);
                }
            });

            visibleItems.sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return a.dataset.name.localeCompare(b.dataset.name);
                    case 'bookings':
                        return parseInt(b.dataset.bookings) - parseInt(a.dataset.bookings);
                    case 'revenue':
                        return parseFloat(b.dataset.revenue) - parseFloat(a.dataset.revenue);
                    default:
                        return 0;
                }
            });

            visibleItems.forEach(item => customerList.appendChild(item));
            noResultsMessage.classList.toggle('d-none', visibleItems.length > 0);
        }

        const debouncedUpdate = debounce(updateCustomerView);
        searchInput.addEventListener('input', debouncedUpdate);
        sortSelect.addEventListener('change', updateCustomerView);
        updateCustomerView();
    });
</script>

</body>
</html>