<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Đăng Ký Khách Sạn Của Bạn - Booking</title>

    <!-- Meta Tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="author" content="StackBros">
    <meta name="description" content="Đăng ký khách sạn của bạn và bắt đầu cho thuê phòng trên Booking.">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <!-- Dark mode -->
    <script>
        const storedTheme = localStorage.getItem('theme')

        const getPreferredTheme = () => {
            if (storedTheme) {
                return storedTheme
            }
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
        }

        const setTheme = function (theme) {
            if (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.setAttribute('data-bs-theme', 'dark')
            } else {
                document.documentElement.setAttribute('data-bs-theme', theme)
            }
        }

        setTheme(getPreferredTheme())

        window.addEventListener('DOMContentLoaded', () => {
            var el = document.querySelector('.theme-icon-active');
            if (el != 'undefined' && el != null) {
                const showActiveTheme = theme => {
                    const activeThemeIcon = document.querySelector('.theme-icon-active use')
                    const btnToActive = document.querySelector(`[data-bs-theme-value="${theme}"]`)
                    const svgOfActiveBtn = btnToActive.querySelector('.mode-switch use').getAttribute('href')

                    document.querySelectorAll('[data-bs-theme-value]').forEach(element => {
                        element.classList.remove('active')
                    })

                    btnToActive.classList.add('active')
                    activeThemeIcon.setAttribute('href', svgOfActiveBtn)
                }

                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                    if (storedTheme !== 'light' || storedTheme !== 'dark') {
                        setTheme(getPreferredTheme())
                    }
                })

                showActiveTheme(getPreferredTheme())

                document.querySelectorAll('[data-bs-theme-value]')
                    .forEach(toggle => {
                        toggle.addEventListener('click', () => {
                            const theme = toggle.getAttribute('data-bs-theme-value')
                            localStorage.setItem('theme', theme)
                            setTheme(theme)
                            showActiveTheme(theme)
                        })
                    })

            }
        })

    </script>

    <!-- Favicon -->
    <link rel="shortcut icon" href="assets/images/favicon.ico">

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Poppins:wght@400;500;700&display=swap">

    <!-- Plugins CSS -->
    <link rel="stylesheet" type="text/css" href="assets/vendor/font-awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="assets/vendor/bootstrap-icons/bootstrap-icons.css">
    <link rel="stylesheet" type="text/css" href="assets/vendor/choices/css/choices.min.css">
    <link rel="stylesheet" type="text/css" href="assets/vendor/stepper/css/bs-stepper.min.css">
    <link rel="stylesheet" type="text/css" href="assets/vendor/quill/css/quill.snow.css">
    <link rel="stylesheet" type="text/css" href="assets/vendor/dropzone/css/dropzone.css">


    <!-- Theme CSS -->
    <link rel="stylesheet" type="text/css" href="assets/css/style.css">
    <style>
        /* Ensure map has a height */
        #hotelLocationMap {
            height: 350px; /* You can adjust this height */
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 0.25rem;
        }

        /* Corrected map container ID for styling if needed */
        #interactiveHotelMap {
            height: 300px; /* Or whatever height you set in the HTML */
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 0.25rem;
        }

        /* Enhanced form validation styles */
        .form-control.is-invalid,
        .form-select.is-invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        .form-control.is-valid,
        .form-select.is-valid {
            border-color: #198754;
            box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
        }

        .invalid-feedback {
            display: block;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875em;
            color: #dc3545;
            font-weight: 500;
        }

        .valid-feedback {
            display: block;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875em;
            color: #198754;
        }

        /* Checkbox validation styling */
        .form-check-input.is-invalid {
            border-color: #dc3545;
        }

        .form-check-input.is-valid {
            border-color: #198754;
        }

        /* File input validation styling */
        .form-control[type="file"].is-invalid {
            border-color: #dc3545;
            background-color: rgba(220, 53, 69, 0.05);
        }

        .form-control[type="file"].is-valid {
            border-color: #198754;
            background-color: rgba(25, 135, 84, 0.05);
        }

        /* Validation for dropzone areas */
        .dropzone.is-invalid {
            border-color: #dc3545 !important;
            background-color: rgba(220, 53, 69, 0.05);
        }

        .dropzone.is-valid {
            border-color: #198754 !important;
            background-color: rgba(25, 135, 84, 0.05);
        }

        /* Error animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.6s ease-in-out;
        }

        /* Required field indicator */
        .required-indicator {
            color: #dc3545;
            font-weight: bold;
        }

        /* Focus highlight for invalid fields */
        .focus-highlight {
            box-shadow: 0 0 0 0.3rem rgba(220, 53, 69, 0.4) !important;
            border-color: #dc3545 !important;
            position: relative;
        }

        .focus-highlight::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #dc3545, transparent, #dc3545);
            border-radius: 6px;
            z-index: -1;
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 0.3; }
        }

        /* Enhanced shake animation */
        @keyframes shake-enhanced {
            0%, 100% { transform: translateX(0) scale(1); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px) scale(1.02); }
            20%, 40%, 60%, 80% { transform: translateX(8px) scale(1.02); }
        }

        .shake-enhanced {
            animation: shake-enhanced 0.8s ease-in-out;
        }

        /* Completed step styling */
        .bs-stepper-circle.completed {
            background-color: #198754 !important;
            color: white !important;
            border-color: #198754 !important;
            box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
            position: relative;
        }

        .bs-stepper-circle.completed::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            font-weight: bold;
        }

        /* Step transition animations */
        .bs-stepper-circle {
            transition: all 0.3s ease;
        }

        .step[data-target="#step-hotel-1"] .bs-stepper-circle.completed ~ .bs-stepper-label,
        .step[data-target="#step-hotel-2"] .bs-stepper-circle.completed ~ .bs-stepper-label,
        .step[data-target="#step-hotel-3"] .bs-stepper-circle.completed ~ .bs-stepper-label {
            color: #198754;
            font-weight: 600;
        }

        /* Disable step header buttons completely */
        .step-trigger {
            pointer-events: none !important;
            cursor: default !important;
            opacity: 0.7;
        }

        .step-trigger:hover {
            background: none !important;
            color: inherit !important;
        }

        .bs-stepper-circle {
            pointer-events: none !important;
            cursor: default !important;
        }

        /* Notification system styles */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }

        .notification {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(100%);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            border-left: 4px solid #dc3545;
            background: #fff5f5;
        }

        .notification.success {
            border-left: 4px solid #198754;
            background: #f0fff4;
        }

        .notification.warning {
            border-left: 4px solid #ffc107;
            background: #fffbf0;
        }

        .notification .notification-content {
            flex: 1;
        }

        .notification .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .notification .notification-message {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        .notification .notification-close {
            background: none;
            border: none;
            font-size: 18px;
            color: #999;
            cursor: pointer;
            padding: 0;
            margin-left: 10px;
        }

        .notification .notification-close:hover {
            color: #666;
        }

        .notification.error .notification-title {
            color: #dc3545;
        }

        .notification.success .notification-title {
            color: #198754;
        }

        .notification.warning .notification-title {
            color: #ffc107;
        }
    </style>
</head>

<body>

<!-- Notification Container -->
<div class="notification-container" id="notificationContainer"></div>

<!-- Header START -->
<div th:replace="~{common/header :: header}"></div>
<!-- Header END -->

<!-- **************** MAIN CONTENT START **************** -->
<main>

    <!-- =======================
    Page Banner START -->
    <section class="pt-4 pt-md-5 pb-0">
        <div class="container">
            <div class="row">
                <div class="col-12 text-center">
                    <h1 class="fs-2 mb-2">Đăng Ký Khách Sạn Của Bạn</h1>
                    <p class="mb-0">Chia sẻ thông tin khách sạn của bạn và bắt đầu tiếp cận hàng triệu khách hàng. Chúng
                        tôi sẽ hướng dẫn bạn qua từng bước.</p>
                </div>
            </div>
        </div>
    </section>
    <!-- =======================
    Page Banner END -->

    <!-- =======================
    Steps START -->
    <section>
        <div class="container">
            <!-- Success Message for Profile Completion -->
            <div th:if="${success}" class="alert alert-success border-start border-4 border-success bg-light shadow-sm mb-4" role="alert" style="border-left-color: #198754 !important;">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 me-3">
                        <div class="bg-success rounded-circle d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                            <i class="bi bi-check-circle text-white fs-5"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="alert-heading text-success mb-2">
                            <i class="bi bi-shield-check me-2"></i>Hồ sơ đã hoàn thiện!
                        </h5>
                        <p class="mb-0 text-dark" th:text="${success}">Thông báo thành công</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>

            <!-- Draft Management Section -->
            <div id="draftManagementSection" class="row mb-4" style="display: none;">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="bi bi-save me-2"></i>Nháp đã lưu</h6>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted mb-3">Bạn có thể tiếp tục từ các bản nháp đã lưu trước đó:</p>
                            <div id="draftList" class="row g-2">
                                <!-- Drafts will be loaded here by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="hostStepper" class="bs-stepper stepper-outline">
                <!-- Step Buttons START -->
                <div class="bs-stepper-header" role="tablist">
                    <!-- Step 1 -->
                    <div class="step" data-target="#step-hotel-1">
                        <div class="text-center">
                            <button type="button" class="btn btn-link step-trigger mb-0" role="tab"
                                    id="stepperHotelTrigger1" aria-controls="step-hotel-1">
                                <span class="bs-stepper-circle">1</span>
                            </button>
                            <h6 class="bs-stepper-label d-none d-md-block">Thông Tin Khách Sạn</h6>
                        </div>
                    </div>
                    <div class="line"></div>

                    <!-- Step 2 -->
                    <div class="step" data-target="#step-hotel-2">
                        <div class="text-center">
                            <button type="button" class="btn btn-link step-trigger mb-0" role="tab"
                                    id="stepperHotelTrigger2" aria-controls="step-hotel-2">
                                <span class="bs-stepper-circle">2</span>
                            </button>
                            <h6 class="bs-stepper-label d-none d-md-block">Chi Tiết Loại Phòng Cơ Bản</h6>
                        </div>
                    </div>
                    <div class="line"></div>

                    <!-- Step 3 -->
                    <div class="step" data-target="#step-hotel-3">
                        <div class="text-center">
                            <button type="button" class="btn btn-link step-trigger mb-0" role="tab"
                                    id="stepperHotelTrigger3" aria-controls="step-hotel-3">
                                <span class="bs-stepper-circle">3</span>
                            </button>
                            <h6 class="bs-stepper-label d-none d-md-block">Chính Sách & Đăng Ký</h6>
                        </div>
                    </div>
                </div>
                <!-- Step Buttons END -->

                <!-- Step content START -->
                <div class="bs-stepper-content p-0 pt-4 pt-md-5">
                    <form th:action="@{/register-host}" method="POST" enctype="multipart/form-data"
                          id="registerHostForm">

                        <!-- Step 1 content START: Hotel Information -->
                        <div id="step-hotel-1" role="tabpanel" class="content fade"
                             aria-labelledby="stepperHotelTrigger1">
                            <div class="vstack gap-4">
                                <h4 class="mb-0">Cung cấp thông tin về khách sạn của bạn</h4>

                                <!-- Hotel Basic Information -->
                                <div class="card shadow">
                                    <div class="card-header border-bottom">
                                        <h5 class="mb-0">Thông Tin Cơ Bản Khách Sạn</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="col-12 mb-3">
                                            <label class="form-label">Tên khách sạn của bạn *</label>
                                            <input required class="form-control" type="text"
                                                   placeholder="Ví dụ: Khách Sạn Sen Vàng" id="hotelName"
                                                   name="hotelName" th:value="${hotelName}">

                                        </div>
                                        <div class="col-12 mb-3">
                                            <label for="hotelDescription" class="form-label">Mô tả về khách sạn của bạn
                                                *</label>
                                            <textarea required id="hotelDescription" name="hotelDescription" class="form-control"
                                                      rows="5" th:text="${hotelDescription}"></textarea>

                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">Ảnh đại diện khách sạn *</label>

                                            <div class="dropzone dropzone-custom"
                                                 data-dropzone='{"maxFiles": 1, "addRemoveLinks": true, "acceptedFiles": "image/*"}'
                                                 id="hotelMainImage">
                                                <div class="dz-message needsclick">
                                                    <i class="bi bi-image-fill display-3"></i>
                                                    <p>Kéo thả một ảnh hoặc nhấp để tải lên.</p>
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <label for="hotelImageUpload" class="form-label">Hoặc chọn ảnh từ máy
                                                    tính của bạn</label>
                                                <!--                                                upload file here-->
                                                <input class="form-control" type="file" id="hotelImageUpload"
                                                       name="hotelImage" accept="image/*">
                                                <small class="form-text text-muted">Chọn ảnh JPG/PNG từ thiết
                                                    bị.</small>
                                            </div>

                                            <!--  Preview and hidden input -->
                                            <img id="imagePreview" src=""
                                                 style="max-width: 300px; display:none; margin-top:10px;"/>
                                            <input type="hidden" id="imageUrl" name="imageUrl">

                                            <small>Ảnh này sẽ là ảnh chính cho khách sạn của bạn.</small>
                                        </div>

                                    </div>
                                </div>

                                <!-- Hotel Location -->
                                <div class="card shadow">
                                    <div class="card-header border-bottom">
                                        <h5 class="mb-0">Vị Trí Khách Sạn</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <div class="col-12">
                                                <label class="form-label" for="hotelAddress">Địa chỉ khách sạn *</label>
                                                <input required class="form-control" type="text"
                                                       placeholder="Ví dụ: 123 Đường ABC, Phường XYZ, Quận 1"
                                                       name="hotelAddress" id="hotelAddress" th:value="${hotelAddress}">
                                                <small>Địa chỉ chính xác sẽ giúp khách hàng tìm thấy bạn. Nhập địa chỉ
                                                    có thể giúp định vị bản đồ.</small>
                                            </div>

                                            <div class="col-md">
                                                <label class="form-label" for="hotelLocation">Khu vực/Địa điểm *</label>
                                                <select required class="form-select js-choice" id="hotelLocation"
                                                        name="hotelLocationId" data-search-enabled="true">
                                                    <option value="">Chọn địa điểm</option>
                                                    <!--/* Iterate over locations from the model */-->
                                                    <th:block th:each="location : ${session.locations}">
                                                        <option th:value="${location.id}"
                                                                th:text="${location.cityName}"
                                                                th:selected="${location.id == hotelLocation}">Location Name
                                                        </option>
                                                    </th:block>
                                                </select>
                                            </div>

                                            <!-- Interactive Map Integration START -->
                                            <div class="col-12 mt-3">
                                                <label class="form-label">Chọn vị trí trên bản đồ hoặc nhập tọa độ thủ
                                                    công:</label>
                                                <div id="interactiveHotelMap">
                                                    <!-- Map will be initialized here by Leaflet -->
                                                </div>
                                                <small class="form-text text-muted">Kéo thả ghim hoặc nhấp vào bản đồ để
                                                    chọn vị trí. Tọa độ sẽ tự động cập nhật bên dưới.</small>
                                            </div>
                                            <!-- Interactive Map Integration END -->

                                            <!-- Manual Latitude and Longitude Input START -->
                                            <div class="col-md-6 mt-2">
                                                <label for="hotelLatitudeManual" class="form-label">Vĩ độ
                                                    (Latitude)</label>
                                                <input type="text" class="form-control" id="hotelLatitudeManual"
                                                       required name="hotelLatitude" placeholder="Ví dụ: 21.028511"
                                                       th:value="${hotelLatitude}">
                                            </div>
                                            <div class="col-md-6 mt-2">
                                                <label for="hotelLongitudeManual" class="form-label">Kinh độ
                                                    (Longitude)</label>
                                                <input type="text" class="form-control" id="hotelLongitudeManual"
                                                       required name="hotelLongitude" placeholder="Ví dụ: 105.854167"
                                                       th:value="${hotelLongitude}">
                                            </div>
                                            <div class="col-12">
                                                <small class="form-text text-muted">
                                                    Tọa độ sẽ được cập nhật từ bản đồ, hoặc bạn có thể nhập thủ công.
                                                </small>
                                            </div>
                                            <!-- Manual Latitude and Longitude Input END -->
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-info" onclick="showSaveDraftModal()">
                                        <i class="bi bi-save me-1"></i>Lưu nháp
                                    </button>
                                    <button class="btn btn-primary next-btn mb-0">Tiếp Theo</button>
                                </div>
                            </div>
                        </div>
                        <!-- Step 1 content END -->

                        <!-- Step 2 content START: Initial Room Type Details -->
                        <div id="step-hotel-2" role="tabpanel" class="content fade"
                             aria-labelledby="stepperHotelTrigger2">
                            <div class="vstack gap-4">
                                <h4 class="mb-0">Thiết lập loại phòng đầu tiên của bạn</h4>
                                <p>Bạn có thể thêm nhiều loại phòng khác sau khi khách sạn được đăng ký.</p>

                                <!-- Room Details -->
                                <div class="card shadow">
                                    <div class="card-header border-bottom">
                                        <h5 class="mb-0">Thông Tin Loại Phòng</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <div class="col-12">
                                                <label class="form-label">Tên/Tiêu đề phòng *</label>
                                                <input type="text" class="form-control" required
                                                       placeholder="Ví dụ: Phòng Standard giường đôi hướng phố"
                                                       name="roomTitle" id="roomTitle" th:value="${roomTitle}">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Số khách tối đa / phòng *</label>
                                                <input name="roomMaxGuests" type="number" class="form-control" required
                                                       placeholder="Số lượng khách"
                                                       min="1" id="roomMaxGuests" th:value="${roomMaxGuests}">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Số lượng phòng loại này *</label>
                                                <input type="number" class="form-control" placeholder="Số lượng" min="1" required
                                                       name="roomQuantity" id="roomQuantity" th:value="${roomQuantity}">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Giá mỗi đêm (VND) *</label>
                                                <input type="number" class="form-control" placeholder="Giá phòng" required
                                                       name="roomPrice" min="0" id="roomPrice" th:value="${roomPrice}">
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label" for="roomDescription">Mô tả chi tiết về loại
                                                    phòng này *</label>
                                                <textarea id="roomDescription" name="roomDescription"
                                                          class="form-control" rows="5" required
                                                          placeholder="Mô tả về kích thước phòng, loại giường, tầm nhìn, và các đặc điểm nổi bật khác."
                                                          th:text="${roomDescription}"></textarea>
                                            </div>

                                        </div>
                                    </div>
                                </div>

                                <!-- Room Amenities -->
                                <div class="card shadow">
                                    <div class="card-header border-bottom">
                                        <h5 class="mb-0">Tiện Nghi Phòng</h5>
                                    </div>
                                    <div class="card-body">
                                        <label class="form-label mb-3">Chọn các tiện nghi có trong loại phòng
                                            này:</label>

                                        <!--                                        Map.Entry<String, List<Amenity>> entry : groupedAmenities.entrySet()-->
                                        <div th:each="entry : ${groupedAmenities}">
                                            <h6 class="fw-bold mb-2" th:text="${entry.key}">Tên danh mục</h6>
                                            <div class="row">
                                                <div class="col-sm-6 col-md-4" th:each="amenity : ${entry.value}">
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input"
                                                               type="checkbox"
                                                               th:id="'amenity-' + ${amenity.amenityId}"
                                                               th:name="amenities"
                                                               th:value="${amenity.amenityId}"
                                                               th:checked="${selectedAmenities != null and selectedAmenities.contains(amenity.amenityId)}"/>
                                                        <label class="form-check-label"
                                                               th:for="'amenity-' + ${amenity.amenityId}"
                                                               th:text="${amenity.name}"></label>
                                                    </div>
                                                </div>
                                            </div>
                                            <hr class="my-3"/>
                                        </div>
                                    </div>
                                </div>

                                <!-- Room Photos -->
                                <div class="card shadow">
                                    <div class="card-header border-bottom">
                                        <h5 class="mb-0">Hình Ảnh Loại Phòng</h5>
                                    </div>
                                    <div class="card-body">
                                        <label class="form-label">Tải lên hình ảnh cho loại phòng này (từ 3 đến 5 ảnh)
                                            *</label>
                                        <div class="dropzone dropzone-custom"
                                             data-dropzone='{"maxFiles": 5, "addRemoveLinks": true, "acceptedFiles": "image/*"}'
                                             id="roomImages">
                                            <div class="dz-message needsclick">
                                                <i class="bi bi-images display-3"></i>
                                                <p>Kéo thả tệp vào đây hoặc nhấp để tải lên.</p>
                                                <p><small class="text-muted">Tối thiểu 3 ảnh, tối đa 5 ảnh</small></p>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <label for="roomImageUpload" class="form-label">Hoặc chọn ảnh từ máy tính
                                                của bạn</label>
                                            <input class="form-control" type="file" id="roomImageUpload"
                                                   name="roomImageFiles" accept="image/*" multiple>
                                            <small>Chọn từ 3-5 ảnh JPG/PNG từ thiết bị của bạn.</small>
                                            <div id="roomImagePreviewContainer"
                                                 class="mt-3 d-flex flex-wrap gap-2"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="hstack gap-2 flex-wrap justify-content-between">
                                <button class="btn btn-secondary prev-btn mb-0">Trước</button>
                                <div class="hstack gap-2">
                                    <button type="button" class="btn btn-outline-info" onclick="showSaveDraftModal()">
                                        <i class="bi bi-save me-1"></i>Lưu nháp
                                    </button>
                                    <button class="btn btn-primary next-btn mb-0">Tiếp Theo</button>
                                </div>
                            </div>
                        </div>
                        <!-- Step 2 content END -->

                        <!-- Step 3 content START: Policies & Registration -->
                        <div id="step-hotel-3" role="tabpanel" class="content fade"
                             aria-labelledby="stepperHotelTrigger3">
                            <div class="vstack gap-4">
                                <h4 class="mb-0">Chính sách khách sạn và hoàn tất đăng ký</h4>

                                <!-- Hotel Policies / House Rules -->
                                <div class="card shadow">
                                    <div class="card-header border-bottom">
                                        <h5 class="mb-0">Nội Quy & Chính Sách Khách Sạn</h5>
                                    </div>
                                    <div class="card-body">
                                        <label class="form-label">Quy định chung cho khách (ví dụ: giờ nhận/trả phòng,
                                            chính
                                            sách hút thuốc, vật nuôi, hủy phòng...) *</label>
                                        <textarea name="hotelPolicies" class="form-control" rows="5"
                                                  placeholder="Ví dụ: Giờ nhận phòng: 14:00, Giờ trả phòng: 12:00. Không hút thuốc trong phòng. Cho phép vật nuôi nhỏ với phụ phí..."
                                                  id="hotelPolicies" required th:text="${hotelPolicies}"></textarea>
                                    </div>
                                </div>

                                <!-- Cancellation & Refund Policy -->
                                <div class="card shadow">
                                    <div class="card-header border-bottom">
                                        <h5 class="mb-0">Chính Sách Hủy Phòng & Hoàn Tiền</h5>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted mb-4">Thiết lập chính sách hoàn tiền khi khách hàng hủy đặt phòng. Chính sách này sẽ giúp khách hàng hiểu rõ điều kiện hoàn tiền.</p>
                                        
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Số ngày trước check-in để được hoàn tiền một phần *</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" name="partialRefundDays" 
                                                           id="partialRefundDays" min="1" max="365" value="7" required
                                                           th:value="${partialRefundDays != null ? partialRefundDays : 7}">
                                                    <span class="input-group-text">ngày</span>
                                                </div>
                                                <small class="text-muted">Khách hàng hủy phòng trước số ngày này sẽ được hoàn tiền một phần</small>
                                            </div>
                                            
                                            <div class="col-md-6">
                                                <label class="form-label">Phần trăm hoàn tiền *</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" name="partialRefundPercent" 
                                                           id="partialRefundPercent" min="10" max="100" value="50" required
                                                           th:value="${partialRefundPercent != null ? partialRefundPercent : 50}">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                                <small class="text-muted">Phần trăm tiền được hoàn lại khi hủy trong thời gian cho phép</small>
                                            </div>
                                            
                                            <div class="col-md-6">
                                                <label class="form-label">Số ngày trước check-in không được hoàn tiền *</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" name="noRefundWithinDays" 
                                                           id="noRefundWithinDays" min="0" max="365" value="1" required
                                                           th:value="${noRefundWithinDays != null ? noRefundWithinDays : 1}">
                                                    <span class="input-group-text">ngày</span>
                                                </div>
                                                <small class="text-muted">Khách hàng hủy phòng trong khoảng thời gian này sẽ không được hoàn tiền</small>
                                            </div>
                                            
                                            <div class="col-12">
                                                <div class="alert alert-info">
                                                    <i class="bi bi-info-circle me-2"></i>
                                                    <strong>Ví dụ:</strong> Với cài đặt <span id="exampleDays">7 ngày - 50% - 1 ngày</span>, 
                                                    khách hàng hủy phòng trước <span id="examplePartialDays">7</span> ngày sẽ được hoàn 
                                                    <span id="examplePercent">50%</span> tiền, còn hủy trong vòng <span id="exampleNoDays">1</span> ngày 
                                                    trước check-in sẽ không được hoàn tiền.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                                <!-- Summary Review -->
                                <div class="card shadow">
                                    <div class="card-header border-bottom">
                                        <h5 class="mb-0">Xem Lại Thông Tin Đăng Ký</h5>
                                    </div>
                                    <div class="card-body">
                                        <p>Vui lòng kiểm tra lại tất cả thông tin bạn đã cung cấp. Bạn có thể quay lại
                                            các bước
                                            trước để chỉnh sửa nếu cần.</p>
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item"><strong>Tên khách sạn:</strong> <span
                                                    id="summaryHotelName">[Sẽ hiển thị ở đây]</span></li>
                                            <li class="list-group-item"><strong>Địa chỉ:</strong> <span
                                                    id="summaryHotelAddress">[Sẽ hiển thị ở đây]</span></li>
                                            <li class="list-group-item"><strong>Thành phố:</strong> <span
                                                    id="summaryHotelCity">[Sẽ hiển thị ở đây]</span>
                                            </li>
                                            <li class="list-group-item"><strong>Vĩ độ:</strong> <span
                                                    id="summaryLatitude">[Sẽ hiển thị ở đây]</span>
                                            </li>
                                            <li class="list-group-item"><strong>Kinh độ:</strong> <span
                                                    id="summaryLongitude">[Sẽ hiển thị ở đây]</span>
                                            </li>
                                            <li class="list-group-item"><strong>Loại phòng cơ bản:</strong> <span
                                                    id="summaryRoomTitle">[Sẽ hiển thị ở đây]</span></li>
                                                                        <li class="list-group-item"><strong>Giá phòng cơ bản:</strong> <span
                                    id="summaryRoomPrice">[Sẽ hiển thị ở đây]</span> VND
                            </li>
                            <li class="list-group-item"><strong>Chính sách hoàn tiền:</strong> <span
                                    id="summaryCancellationPolicy">[Sẽ hiển thị ở đây]</span>
                            </li>
                        </ul>
                                    </div>
                                </div>

                                <!-- Terms and Conditions -->
                                <div class="card shadow">
                                    <div class="card-header border-bottom">
                                        <h5 class="mb-0">Điều Khoản & Cam Kết</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="" id="agreeTerms"
                                                   required>
                                            <label class="form-check-label" for="agreeTerms">
                                                Tôi đồng ý với <a href="terms-of-service.html" target="_blank">Điều
                                                khoản Dịch
                                                vụ</a> và <a href="privacy-policy.html" target="_blank">Chính sách Bảo
                                                mật</a>
                                                của Booking.
                                            </label>
                                        </div>
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" value="" id="hostCommitment"
                                                   required>
                                            <label class="form-check-label" for="hostCommitment">
                                                Tôi cam kết cung cấp thông tin chính xác, dịch vụ chất lượng và tuân thủ
                                                các
                                                tiêu chuẩn của Booking.
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="hstack gap-2 flex-wrap justify-content-between">
                                    <button class="btn btn-secondary prev-btn mb-0">Trước</button>
                                    <div class="hstack gap-2">
                                        <button type="button" class="btn btn-outline-info" onclick="showSaveDraftModal()">
                                            <i class="bi bi-save me-1"></i>Lưu nháp
                                        </button>
                                        <button type="submit" class="btn btn-success mb-0">Gửi Đăng Ký Khách Sạn</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Step 3 content END -->

                    </form>
                </div>
                <!-- Step content END -->
            </div>
        </div>
    </section>
    <!-- =======================
    Steps END -->

</main>
<!-- **************** MAIN CONTENT END **************** -->

<!-- Save Draft Modal -->
<div class="modal fade" id="saveDraftModal" tabindex="-1" aria-labelledby="saveDraftModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveDraftModalLabel">
                    <i class="bi bi-save me-2"></i>Lưu nháp
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="draftNameInput" class="form-label">Tên cho bản nháp của bạn *</label>
                    <input type="text" class="form-control" id="draftNameInput" 
                           placeholder="Ví dụ: Khách sạn biển Nha Trang" required>
                    <small class="text-muted">Đặt tên giúp bạn dễ nhận biết bản nháp này sau này</small>
                </div>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Lưu ý:</strong> Nháp sẽ được lưu trên trình duyệt này. Thông tin sẽ được bảo toàn cho đến khi bạn xóa dữ liệu trình duyệt.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-info" onclick="saveDraftToLocalStorage()">
                    <i class="bi bi-save me-1"></i>Lưu nháp
                </button>
            </div>
        </div>
    </div>
</div>

<!-- =======================
Footer START -->
<div th:replace="~{common/footer :: footer}"></div>
<!-- =======================
Footer END -->

<!-- Back to top -->
<div class="back-top"></div>

<!-- Bootstrap JS -->
<script src="assets/vendor/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<!-- Vendors -->
<script src="assets/vendor/choices/js/choices.min.js"></script>
<script src="assets/vendor/stepper/js/bs-stepper.min.js"></script>
<script src="assets/vendor/quill/js/quill.min.js"></script>
<script src="assets/vendor/dropzone/js/dropzone.js"></script>
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
<!-- ThemeFunctions -->
<script src="assets/js/functions.js"></script>


<!--
                      Map & Location Functions
initializeHotelMap() - Creates interactive Leaflet map with Vietnam bounds and draggable marker
updateLatLngInputs(latlng) - Updates latitude/longitude input fields when marker moves

geocodeAddressAndSetMap() - Converts address text to coordinates and updates map position

                 Form Validation Functions
validateImageUploads() - Checks if required hotel and room images are uploaded (multiple validation methods)
showNotification(type, title, message, duration) - Displays colored notification popups
showErrorNotification() / showSuccessNotification() / showWarningNotification() - Wrapper functions for specific notification types
showFieldError(element, message) - Adds error styling and message to form fields
removeFieldError(element) - Removes error styling and messages
showFieldSuccess(element) - Adds success styling to valid form fields
validateField(element) - Validates individual form field against defined rules
validateSelect(element) - Validates dropdown selections
validateFileInput(element) - Validates file upload inputs
validateCheckboxes() - Validates required checkboxes and amenity selections
validateCurrentStep() - Validates all fields in the currently visible step
validateCurrentStepFields(stepNumber) - Comprehensive validation for specific steps
markStepAsCompleted(stepNumber) - Adds visual "completed" styling to step headers

             Stepper Navigation Functions
updateSummary() - Populates the final review step with user-entered data
controlStepHeaderButtons() - Prevents skipping ahead to incomplete steps
getCurrentStepIndex() - Returns which step (0-2) is currently active
isStepCompleted(stepNumber) - Checks if a step has been marked as completed

              Image Upload Functions
Hotel Image Upload:
handleFile(file) - Processes single hotel image upload (drag/drop or file input)
Room Image Upload:
addFiles(newFiles) - Adds multiple room images to upload queue
renderPreviews() - Creates thumbnail previews with delete buttons
updateInputFiles() - Syncs file list with actual form input for submission-->

<script>
    // Global variable to hold Choices.js instances, making them accessible to other scripts
    var choicesInstances = {};

    // Global variables to track dropzone uploads - make them truly global
    var hotelImageUploaded = false;
    var roomImagesCount = 0;

    // Function to update cancellation policy example
    function updateCancellationExample() {
        const partialDays = document.getElementById('partialRefundDays').value || 7;
        const refundPercent = document.getElementById('partialRefundPercent').value || 50;
        const noDays = document.getElementById('noRefundWithinDays').value || 1;

        document.getElementById('exampleDays').textContent = partialDays + ' ngày - ' + refundPercent + '% - ' + noDays + ' ngày';
        document.getElementById('examplePartialDays').textContent = partialDays;
        document.getElementById('examplePercent').textContent = refundPercent + '%';
        document.getElementById('exampleNoDays').textContent = noDays;
    }

    // Function to validate cancellation policy in real-time
    function validateCancellationPolicyRealtime() {
        try {
            const partialDaysField = document.getElementById('partialRefundDays');
            const noDaysField = document.getElementById('noRefundWithinDays');

            if (!partialDaysField || !noDaysField) {
                return;
            }

            const partialDays = parseInt(partialDaysField.value) || 0;
            const noDays = parseInt(noDaysField.value) || 0;

            // Clear previous errors
            if (typeof removeFieldError === 'function') {
                removeFieldError(partialDaysField);
                removeFieldError(noDaysField);
            } else {
                // Fallback: remove Bootstrap validation classes
                partialDaysField.classList.remove('is-invalid');
                noDaysField.classList.remove('is-invalid');

                // Remove any existing error messages
                const existingErrors = document.querySelectorAll('#partialRefundDays_error, #noRefundWithinDays_error');
                existingErrors.forEach(error => error.remove());
            }

            // Validate logic: no refund days must be < partial refund days
            if (partialDays > 0 && noDays >= 0 && noDays >= partialDays) {

                if (typeof showFieldError === 'function') {
                    showFieldError(noDaysField, 'Số ngày không hoàn tiền phải nhỏ hơn số ngày hoàn tiền một phần');
                } else {
                    // Fallback: add Bootstrap validation classes
                    noDaysField.classList.add('is-invalid');

                    // Add error message
                    const errorDiv = document.createElement('div');
                    errorDiv.id = 'noRefundWithinDays_error';
                    errorDiv.className = 'invalid-feedback';
                    errorDiv.textContent = 'Số ngày không hoàn tiền phải nhỏ hơn số ngày hoàn tiền một phần';
                    noDaysField.parentNode.appendChild(errorDiv);
                }
            }
        } catch (e) {
            console.warn('Error in validateCancellationPolicyRealtime:', e);
        }
    }

    // Client-side profile completeness validation - DISABLED
    // Server-side validation is the primary and sufficient validation
    function checkProfileCompleteness() {
        // This function is now disabled as server-side validation handles everything
        // If user reaches this page, their profile is complete
        return;
    }

    function showProfileIncompleteWarning(missingFields) {
        const warningHtml = `
            <div class="alert alert-info border-start border-4 border-primary bg-light shadow-sm mb-4" role="alert" style="border-left-color: #0d6efd !important;">
                <div class="d-flex align-items-start">
                    <div class="flex-shrink-0 me-3">
                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                            <i class="bi bi-person-check text-white fs-5"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="alert-heading text-primary mb-2">
                            <i class="bi bi-shield-check me-2"></i>Hoàn thiện hồ sơ để tiếp tục
                        </h5>
                        <p class="mb-3 text-dark" style="line-height: 1.6;">
                            Để đảm bảo chất lượng dịch vụ và tăng độ tin cậy, vui lòng hoàn thiện thông tin cá nhân trước khi đăng ký khách sạn.
                        </p>
                        <div class="mb-3">
                            <h6 class="text-primary mb-2">
                                <i class="bi bi-list-check me-2"></i>Thông tin cần bổ sung:
                            </h6>
                            <div class="row g-2">
                                ${missingFields.map(field => `
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center p-2 bg-white rounded border">
                                            <i class="bi bi-circle text-primary me-2" style="font-size: 8px;"></i>
                                            <span class="text-dark fw-medium">${field}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <a href="/user-profile?incomplete=true&reason=hotel_registration" class="btn btn-primary">
                                <i class="bi bi-person-fill me-2"></i>Hoàn thiện hồ sơ ngay
                            </a>
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Sau khi hoàn thiện, bạn sẽ được chuyển về trang này tự động.
                            </small>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        `;

        // Insert warning at the top of the main content
        const mainContent = document.querySelector('main');
        if (mainContent) {
            mainContent.insertAdjacentHTML('afterbegin', warningHtml);
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Only run client-side validation if server-side validation failed
        // If we're on this page, it means server validation passed, so skip client validation
        // checkProfileCompleteness(); // Commented out - server validation is sufficient

        var stepperEl = document.querySelector('#hostStepper');
        var stepper;


        if (stepperEl) {
            stepper = new Stepper(stepperEl, {
                linear: false, // Set to true if you want to enforce step-by-step progression
                animation: true
            });
        }
        
        // Check if we have draft images in sessionStorage
        const draftImagesStr = sessionStorage.getItem('draftImages');
        if (draftImagesStr) {
            try {
                const draftImages = JSON.parse(draftImagesStr);
                
                // Load hotel image
                if (draftImages.hotelImage) {
                    setTimeout(() => {
                        const file = dataURLtoFile(draftImages.hotelImage, 'hotel_image_from_draft.png');
                        if (file && typeof handleFile === 'function') {
                            handleFile(file);
                        }
                    }, 500);
                }
                
                // Load room images
                if (draftImages.roomImages && Array.isArray(draftImages.roomImages) && draftImages.roomImages.length > 0) {
                    setTimeout(() => {
                        const files = draftImages.roomImages.map((dataUrl, index) => {
                            return dataURLtoFile(dataUrl, `room_image_from_draft_${index}.png`);
                        }).filter(file => file !== null);
                        
                        if (files.length > 0 && typeof addFiles === 'function') {
                            addFiles(files);
                        }
                    }, 700);
                }
                
                // Clear from sessionStorage after loading
                sessionStorage.removeItem('draftImages');
            } catch (e) {
                console.error('Error loading draft images:', e);
            }
        }
        
        // Check if we have draft coordinates from server and update map
        const latInput = document.getElementById('hotelLatitudeManual');
        const lngInput = document.getElementById('hotelLongitudeManual');
        if (latInput && lngInput && latInput.value && lngInput.value) {
            setTimeout(() => {
                if (typeof map !== 'undefined' && map && typeof marker !== 'undefined' && marker) {
                    const lat = parseFloat(latInput.value);
                    const lng = parseFloat(lngInput.value);
                    if (!isNaN(lat) && !isNaN(lng)) {
                        map.setView([lat, lng], 15);
                        marker.setLatLng([lat, lng]);
                        console.log('Updated map with draft coordinates:', lat, lng);
                    }
                }
            }, 1000); // Wait for map initialization
        }

        // Initialize Choices.js
        var choiceElements = document.querySelectorAll('.js-choice');
        choiceElements.forEach(function (el) {
            const enableSearch = el.id === 'hotelLocation';
            // Store the instance in our global object to be accessed later
            choicesInstances[el.id] = new Choices(el, {
                searchEnabled: enableSearch,
                itemSelectText: 'Nhấn để chọn',
            });
        });
        // Finds all selects with .js-choice
        // Enables search only for #hotelLocation
        //   Adds placeholder text "Nhấn để chọn"

        // Add event listeners for cancellation policy fields
        const policyFields = ['partialRefundDays', 'partialRefundPercent', 'noRefundWithinDays'];
        policyFields.forEach(function(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('input', function() {
                    updateCancellationExample();
                    setTimeout(() => validateCancellationPolicyRealtime(), 10);
                });
                field.addEventListener('change', function() {
                    updateCancellationExample();
                    setTimeout(() => validateCancellationPolicyRealtime(), 10);
                });
            }
        });
        
        // Initialize the example display
        updateCancellationExample();

        // Initialize validation (with delay to ensure functions are loaded)
        setTimeout(() => {
            validateCancellationPolicyRealtime();
        }, 100);

        // --- Leaflet Map Integration ---
        var map;
        var marker;
        const hotelLatInput = document.getElementById('hotelLatitudeManual');
        const hotelLngInput = document.getElementById('hotelLongitudeManual');
        const hotelAddressInput = document.getElementById('hotelAddress');
        const hotelLocationSelect = document.getElementById('hotelLocation');
        var mapInitialized = false;           //A flag to prevent the map from being initialized multiple times.
        let geocodeDebounceTimer; // Timer for debouncing address input

        // Define approximate bounds for Vietnam
        // Southwest corner (e.g., Ca Mau peninsula) and Northeast corner (e.g., near Chinese border)
        // You can get more precise bounds from http://bboxfinder.com/
        const vietnamBounds = L.latLngBounds(        // bounding box for the whole country of Vietnam.
            L.latLng(8.18, 102.14), // Southwest
            L.latLng(23.39, 109.46)  // Northeast
        );

        function initializeHotelMap() {
            if (mapInitialized || !document.getElementById('interactiveHotelMap')) return;

            let defaultLat = 16.0479; // Approx center of Vietnam (Da Nang) for a broader initial view
            let defaultLng = 108.2208;
            let defaultZoom = 6;     // Zoom level to see most of Vietnam

            // If existing lat/lng are provided and within Vietnam, use them
            if (hotelLatInput && hotelLatInput.value && hotelLngInput && hotelLngInput.value) {
                try {
                    const latVal = parseFloat(hotelLatInput.value);
                    const lngVal = parseFloat(hotelLngInput.value);
                    if (!isNaN(latVal) && !isNaN(lngVal) && vietnamBounds.contains(L.latLng(latVal, lngVal))) {
                        defaultLat = latVal;
                        defaultLng = lngVal;
                        defaultZoom = 15; // Zoom in closer if specific coords are given
                    } else if (!isNaN(latVal) && !isNaN(lngVal)) {
                        console.warn("Initial coordinates are outside Vietnam bounds. Using default.");
                    }
                } catch (e) {
                    console.warn("Could not parse initial lat/lng from input fields.");
                }
            }

            map = L.map('interactiveHotelMap', {
                center: [defaultLat, defaultLng], // Set initial center
                zoom: defaultZoom,                 // Set initial zoom
                maxBounds: vietnamBounds,          // Restrict panning to these bounds
                maxBoundsViscosity: 1.0,           // Make bounds completely solid
                minZoom: 5                         // Prevent zooming out too far from Vietnam
            });

            // Set view again to ensure it respects bounds if center was slightly off
            map.fitBounds(vietnamBounds); // This will try to fit Vietnam in view
            // Then, if specific coords were given, zoom to them if they are within bounds
            if (defaultZoom === 15) { // Indicates specific coords were likely used
                map.setView([defaultLat, defaultLng], defaultZoom);
            }


            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Ensure initial marker position is within bounds
            let initialMarkerPos = L.latLng(defaultLat, defaultLng);
            if (!vietnamBounds.contains(initialMarkerPos)) {
                initialMarkerPos = vietnamBounds.getCenter(); // Fallback to center of bounds
            }

            marker = L.marker(initialMarkerPos, {
                draggable: true
            }).addTo(map);


            function updateLatLngInputs(latlng) {
                if (hotelLatInput) hotelLatInput.value = latlng.lat.toFixed(6);      //Converts the latitude to a string with 6 decimal places
                if (hotelLngInput) hotelLngInput.value = latlng.lng.toFixed(6);
            }

            marker.on('dragend', function (event) {
                const newPos = marker.getLatLng();
                // Snap marker back inside bounds if dragged out (though maxBounds on map should mostly prevent this view)
                if (!vietnamBounds.contains(newPos)) {
                    marker.setLatLng(vietnamBounds.closestLayerPoint(map.latLngToLayerPoint(newPos)));
                }
                updateLatLngInputs(marker.getLatLng());
            });

            // If the user clicks anywhere on the map, the marker jumps to that point.
            //     Then updates the input fields with the clicked location
            map.on('click', function (e) {
                // Click event latlng should already be within map's maxBounds
                marker.setLatLng(e.latlng);
                updateLatLngInputs(e.latlng);
            });


            if (hotelLatInput && hotelLngInput && (!hotelLatInput.value || !hotelLngInput.value || !vietnamBounds.contains(L.latLng(parseFloat(hotelLatInput.value), parseFloat(hotelLngInput.value))))) {
                updateLatLngInputs(marker.getLatLng());
            }
            mapInitialized = true;
        }



        function geocodeAddressAndSetMap() {
            if (!map) {
                if (!mapInitialized) initializeHotelMap();
                if (!map) {
                    console.error("Map not initialized, cannot geocode.");
                    return;
                }
            }
            if (!hotelAddressInput) return;

            const address = hotelAddressInput.value;
            let cityName = "";
            if (hotelLocationSelect && hotelLocationSelect.value) {
                const selectedOption = hotelLocationSelect.options[hotelLocationSelect.selectedIndex];
                if (selectedOption && selectedOption.value && selectedOption.text !== "Chọn địa điểm") {
                    cityName = selectedOption.text;
                }
            }

            let queryParts = [];
            if (address && address.trim()) {
                queryParts.push(address.trim());
            }
            if (cityName) {
                if (!address || !address.trim() || address.toLowerCase().indexOf(cityName.toLowerCase()) === -1) {
                    queryParts.push(cityName);
                }
            }

            if (queryParts.length === 0 && cityName) {
                queryParts.push(cityName);
            }

            if (queryParts.length === 0) return;

            // Adding "Việt Nam" helps bias, but countrycodes is more explicit
            // queryParts.push("Việt Nam"); // Optional: can keep or remove if countrycodes is used
            let query = queryParts.join(", ");

            if (map.lastGeocodedQuery === query) return;

            // Add countrycodes=vn to restrict search to Vietnam
            // Add viewbox for biasing, using Vietnam's rough bounding box
            // viewbox=longitude_min,latitude_min,longitude_max,latitude_max
            const vnViewbox = `${vietnamBounds.getWest()},${vietnamBounds.getSouth()},${vietnamBounds.getEast()},${vietnamBounds.getNorth()}`;
            const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=vn&viewbox=${vnViewbox}&bounded=1`;


            fetch(nominatimUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Nominatim API request failed: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.length > 0) {
                        // Optionally, you could check if data[0] is within vietnamBounds before using it
                        // but countrycodes=vn should already ensure this.
                        const lat = parseFloat(data[0].lat);
                        const lon = parseFloat(data[0].lon);

                        if (vietnamBounds.contains(L.latLng(lat, lon))) {
                            map.setView([lat, lon], (address && address.trim()) ? 15 : 13);
                            marker.setLatLng([lat, lon]);
                            if (hotelLatInput) hotelLatInput.value = lat.toFixed(6);
                            if (hotelLngInput) hotelLngInput.value = lon.toFixed(6);
                            map.lastGeocodedQuery = query;
                        } else {
                            console.warn('Geocoded result is outside Vietnam bounds (should not happen with countrycodes=vn):', data[0].display_name);
                        }
                    } else {
                        console.warn('Geocoding: No results found for query in Vietnam:', query);
                    }
                })
                .catch(error => {
                    console.error('Error geocoding:', error);
                    if (map) map.lastGeocodedQuery = null;
                });
        }

        if (hotelAddressInput) {
            hotelAddressInput.addEventListener('input', function () {
                clearTimeout(geocodeDebounceTimer);
                geocodeDebounceTimer = setTimeout(() => {
                    geocodeAddressAndSetMap();
                }, 1000);
            });
            hotelAddressInput.addEventListener('blur', geocodeAddressAndSetMap);
        }

        if (hotelLocationSelect) {
            hotelLocationSelect.addEventListener('change', geocodeAddressAndSetMap);
        }

        if (stepperEl) {
            stepperEl.addEventListener('shown.bs-stepper', function (event) {
                if (event.detail.indexStep === 0) {
                    if (!mapInitialized) {
                        initializeHotelMap();
                    }
                    if (map) {
                        setTimeout(function () {
                            map.invalidateSize();
                        }, 100);
                    }
                }
                if (event.detail.indexStep === 2) {
                    updateSummary();
                }
            });
        }

        if (document.querySelector('#step-hotel-1.active') || (stepper && stepper._currentIndex === 0)) {
            if (!mapInitialized) {
                initializeHotelMap();
            }
            if (map) {
                setTimeout(function () {
                    map.invalidateSize();
                }, 100);
            }
        }

        function updateSummary() {
            document.getElementById('summaryHotelName').textContent = document.getElementById('hotelName')?.value || '[Chưa nhập]';
            document.getElementById('summaryHotelAddress').textContent = document.getElementById('hotelAddress')?.value || '[Chưa nhập]';
            let selectedCityText = '[Chưa chọn]';
            if (hotelLocationSelect && hotelLocationSelect.value) {
                const selectedOption = hotelLocationSelect.options[hotelLocationSelect.selectedIndex];
                if (selectedOption && selectedOption.value && selectedOption.text !== "Chọn địa điểm") {
                    selectedCityText = selectedOption.text;
                }
            }
            document.getElementById('summaryHotelCity').textContent = selectedCityText;
            document.getElementById('summaryLatitude').textContent = hotelLatInput?.value || '[Chưa chọn]';
            document.getElementById('summaryLongitude').textContent = hotelLngInput?.value || '[Chưa chọn]';
            document.getElementById('summaryRoomTitle').textContent = document.getElementById('roomTitle')?.value || '[Chưa nhập]';
            document.getElementById('summaryRoomPrice').textContent = document.getElementById('roomPrice')?.value || '[Chưa nhập]';
            
            // Update cancellation policy summary
            const partialDays = document.getElementById('partialRefundDays')?.value || '7';
            const refundPercent = document.getElementById('partialRefundPercent')?.value || '50';
            const noDays = document.getElementById('noRefundWithinDays')?.value || '1';
            const policyText = `Hoàn ${refundPercent}% nếu hủy trước ${partialDays} ngày, không hoàn tiền trong ${noDays} ngày cuối`;
            document.getElementById('summaryCancellationPolicy').textContent = policyText;
        }

        // --- Enhanced Form Validation Logic ---
        const form = document.getElementById('registerHostForm');

        // Global variables to track dropzone uploads
        let hotelImageUploaded = false;
        let roomImagesCount = 0;

        // Enhanced image validation that checks both file input and dropzone
        function validateImageUploads() {
            // Check hotel image - multiple methods: file input, preview display, URL input, global flag
            const hotelImageInput = document.getElementById('hotelImageUpload');
            const imageUrl = document.getElementById('imageUrl');
            const hotelImagePreview = document.getElementById('imagePreview');

            let hotelImageValid = false;

            // Check file input (traditional upload)
            if (hotelImageInput && hotelImageInput.files.length > 0) {
                hotelImageValid = true;
            }
            // Check if image preview is visible and has source (drag-and-drop or any upload)
            else if (hotelImagePreview && hotelImagePreview.style.display !== 'none' && hotelImagePreview.src && hotelImagePreview.src !== window.location.href && hotelImagePreview.src !== '') {
                hotelImageValid = true;
            }
            // Check URL input (manual URL entry)
            else if (imageUrl && imageUrl.value.trim() !== '') {
                hotelImageValid = true;
            }
            // Check global upload flag (set by drag-and-drop handlers)
            else if (window.hotelImageUploaded === true) {
                hotelImageValid = true;
            }

            // Check room images - multiple methods: file input, preview containers, global counter
            const roomImageInput = document.getElementById('roomImageUpload');
            const roomImagePreviews = document.querySelectorAll('#roomImagePreviewContainer img');
            const maxRoomImages = 5;
            const minRoomImages = 3;

            let roomImagesValid = false;
            let roomImagesCount = 0;
            let roomImagesErrorMessage = '';

            // Get the actual count from different sources
            if (roomImageInput && roomImageInput.files.length > 0) {
                roomImagesCount = roomImageInput.files.length;
            } else if (roomImagePreviews.length > 0) {
                roomImagesCount = roomImagePreviews.length;
            } else if (window.roomImagesCount > 0) {
                roomImagesCount = window.roomImagesCount;
            }

            // Validate room images count
            if (roomImagesCount < minRoomImages) {
                roomImagesErrorMessage = `Vui lòng tải lên ít nhất ${minRoomImages} ảnh phòng (hiện tại: ${roomImagesCount}/${maxRoomImages})`;
                roomImagesValid = false;
            } else if (roomImagesCount > maxRoomImages) {
                roomImagesErrorMessage = `Số lượng ảnh vượt quá giới hạn. Tối đa ${maxRoomImages} ảnh (hiện tại: ${roomImagesCount}/${maxRoomImages})`;
                roomImagesValid = false;
            } else {
                roomImagesValid = true;
            }

            // Debug logging to help troubleshoot
            console.log('Hotel Image Validation:', {
                fileInputCount: hotelImageInput ? hotelImageInput.files.length : 0,
                previewVisible: hotelImagePreview ? hotelImagePreview.style.display !== 'none' : false,
                previewHasSrc: hotelImagePreview ? (hotelImagePreview.src && hotelImagePreview.src !== window.location.href && hotelImagePreview.src !== '') : false,
                urlValue: imageUrl ? imageUrl.value.trim() : '',
                globalFlag: window.hotelImageUploaded,
                finalResult: hotelImageValid
            });

            console.log('Room Images Validation:', {
                fileInputCount: roomImageInput ? roomImageInput.files.length : 0,
                previewCount: roomImagePreviews.length,
                globalCount: window.roomImagesCount,
                actualCount: roomImagesCount,
                minRequired: minRoomImages,
                maxAllowed: maxRoomImages,
                errorMessage: roomImagesErrorMessage,
                finalResult: roomImagesValid
            });

            return { 
                hotelImageValid, 
                roomImagesValid, 
                roomImagesCount, 
                roomImagesErrorMessage,
                maxRoomImages,
                minRoomImages
            };
        }

        // Notification System
        function showNotification(type, title, message, duration = 5000) {
            const container = document.getElementById('notificationContainer');

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;

            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">×</button>
            `;

            container.appendChild(notification);

            // Trigger animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // Auto remove after duration
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, duration);
        }

        function showErrorNotification(title, message = '') {
            const notification = document.getElementById('notification');
            const notificationTitle = document.getElementById('notificationTitle');
            const notificationMessage = document.getElementById('notificationMessage');
            
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            
            notification.className = 'notification error show';
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        function showSuccessNotification(title, message) {
            showNotification('success', title, message);
        }

        function showWarningNotification(title, message = '') {
            const notification = document.getElementById('notification');
            const notificationTitle = document.getElementById('notificationTitle');
            const notificationMessage = document.getElementById('notificationMessage');
            
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            
            notification.className = 'notification warning show';
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // Validation rules and messages
        const validationRules = {
            'hotelName': {
                required: true,
                minLength: 3,
                message: 'Tên khách sạn phải có ít nhất 3 ký tự'
            },
            'hotelDescription': {
                required: true,
                minLength: 10,
                message: 'Mô tả khách sạn phải có ít nhất 10 ký tự'
            },
            'hotelAddress': {
                required: true,
                minLength: 5,
                message: 'Địa chỉ phải có ít nhất 5 ký tự'
            },
            'hotelLocationId': {
                required: true,
                message: 'Vui lòng chọn địa điểm'
            },
            'hotelLatitude': {
                required: true,
                isNumber: true,
                range: [-90, 90],
                message: 'Vĩ độ phải là số từ -90 đến 90'
            },
            'hotelLongitude': {
                required: true,
                isNumber: true,
                range: [-180, 180],
                message: 'Kinh độ phải là số từ -180 đến 180'
            },
            'roomTitle': {
                required: true,
                minLength: 3,
                message: 'Tên phòng phải có ít nhất 3 ký tự'
            },
            'roomMaxGuests': {
                required: true,
                isNumber: true,
                min: 1,
                max: 20,
                message: 'Số khách tối đa phải từ 1 đến 20'
            },
            'roomQuantity': {
                required: true,
                isNumber: true,
                min: 1,
                max: 100,
                message: 'Số lượng phòng phải từ 1 đến 100'
            },
            'roomPrice': {
                required: true,
                isNumber: true,
                min: 1000,
                max: 50000000,
                message: 'Giá phòng phải từ 1,000 VND đến 50,000,000 VND'
            },
            'roomDescription': {
                required: true,
                minLength: 10,
                message: 'Mô tả phòng phải có ít nhất 10 ký tự'
            },
            'hotelPolicies': {
                required: true,
                minLength: 10,
                message: 'Quy định khách sạn phải có ít nhất 10 ký tự'
            }
        };

        // Function to show error message
        function showFieldError(element, message) {
            // Remove existing error
            removeFieldError(element);

            // Add error class
            element.classList.add('is-invalid');

            // Add shake animation
            element.classList.add('shake');
            setTimeout(() => {
                element.classList.remove('shake');
            }, 600);

            // Create error message element
            const errorDiv = document.createElement('div');
            errorDiv.className = 'invalid-feedback';
            errorDiv.textContent = message;
            errorDiv.id = element.id + '_error';

            // Insert error message after the element
            element.parentNode.insertBefore(errorDiv, element.nextSibling);
        }

        // Function to remove error message
        function removeFieldError(element) {
            element.classList.remove('is-invalid');
            const existingError = document.getElementById(element.id + '_error');
            if (existingError) {
                existingError.remove();
            }
        }

        // Function to show success state
        function showFieldSuccess(element) {
            removeFieldError(element);
            element.classList.add('is-valid');


        }

        // Function to validate individual field
        function validateField(element) {
            const fieldName = element.name || element.id;
            const rule = validationRules[fieldName];
            const value = element.value.trim();

            // Remove previous validation states
            element.classList.remove('is-valid', 'is-invalid');

            if (!rule) return true; // No validation rule defined

            // Required field check
            if (rule.required && value === '') {
                showFieldError(element, rule.message || 'Trường này là bắt buộc');
                return false;
            }

            // If field is empty but not required, skip other validations
            if (value === '' && !rule.required) return true;

            // Minimum length check
            if (rule.minLength && value.length < rule.minLength) {
                showFieldError(element, rule.message);
                return false;
            }

            // Number validation
            if (rule.isNumber) {
                const numValue = parseFloat(value);
                if (isNaN(numValue)) {
                    showFieldError(element, 'Giá trị phải là số');
                    return false;
                }

                // Range check
                if (rule.range && (numValue < rule.range[0] || numValue > rule.range[1])) {
                    showFieldError(element, rule.message);
                    return false;
                }

                // Minimum value check
                if (rule.min !== undefined && numValue < rule.min) {
                    showFieldError(element, rule.message);
                    return false;
                }

                // Maximum value check
                if (rule.max !== undefined && numValue > rule.max) {
                    showFieldError(element, rule.message);
                    return false;
                }
            }

            showFieldSuccess(element);
            return true;
        }

        // Function to validate select fields
        function validateSelect(element) {
            const value = element.value;
            if (element.hasAttribute('required') && (value === '' || value === null)) {
                showFieldError(element, 'Vui lòng chọn một lựa chọn');
                return false;
            }
            showFieldSuccess(element);
            return true;
        }

        // Function to validate file inputs
        function validateFileInput(element) {
            const files = element.files;

            if (element.id === 'hotelImageUpload') {
                // Check if either file is uploaded or URL is provided
                const imageUrl = document.getElementById('imageUrl');
                if (files.length === 0 && (!imageUrl || imageUrl.value.trim() === '')) {
                    showFieldError(element, 'Vui lòng tải lên ảnh khách sạn');
                    return false;
                }
            } else if (element.id === 'roomImageUpload') {
                const imageValidation = validateImageUploads();
                if (!imageValidation.roomImagesValid) {
                    showFieldError(element, imageValidation.roomImagesErrorMessage);
                    return false;
                }
            }

            showFieldSuccess(element);
            return true;
        }

        // Function to validate checkboxes
        function validateCheckboxes() {
            let isValid = true;

            // Validate required checkboxes (terms and commitment)
            const agreeTerms = document.getElementById('agreeTerms');
            const hostCommitment = document.getElementById('hostCommitment');

            if (agreeTerms && !agreeTerms.checked) {
                showFieldError(agreeTerms, 'Bạn phải đồng ý với điều khoản dịch vụ');
                isValid = false;
            } else if (agreeTerms) {
                showFieldSuccess(agreeTerms);
            }

            if (hostCommitment && !hostCommitment.checked) {
                showFieldError(hostCommitment, 'Bạn phải cam kết tuân thủ tiêu chuẩn');
                isValid = false;
            } else if (hostCommitment) {
                showFieldSuccess(hostCommitment);
            }

            // Validate amenities (at least one should be selected)
            const amenityCheckboxes = document.querySelectorAll('input[name="amenities"]:checked');
            if (amenityCheckboxes.length === 0) {
                const firstAmenityCheckbox = document.querySelector('input[name="amenities"]');
                if (firstAmenityCheckbox) {
                    showFieldError(firstAmenityCheckbox.parentNode, 'Vui lòng chọn ít nhất một tiện nghi');
                    isValid = false;
                }
            }

            return isValid;
        }

        // Function to validate current step
        function validateCurrentStep() {
            const currentStep = document.querySelector('.content.fade.active') || document.querySelector('.content.fade.dstepper-block');
            if (!currentStep) return true;

            let stepValid = true;

            // Validate all inputs in current step
            currentStep.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(element => {
                if (!validateField(element)) {
                    stepValid = false;
                }
            });

            // Validate selects in current step
            currentStep.querySelectorAll('select').forEach(element => {
                if (!validateSelect(element)) {
                    stepValid = false;
                }
            });

            // Validate file inputs in current step
            currentStep.querySelectorAll('input[type="file"]').forEach(element => {
                if (!validateFileInput(element)) {
                    stepValid = false;
                }
            });

            return stepValid;
        }

        // Add real-time validation
        if (form) {
            // Add event listeners for real-time validation
            form.addEventListener('input', function(event) {
                const element = event.target;

                if (element.type === 'text' || element.type === 'number' || element.tagName === 'TEXTAREA') {
                    validateField(element);
                }
            });

            form.addEventListener('change', function(event) {
                const element = event.target;

                if (element.tagName === 'SELECT') {
                    validateSelect(element);
                } else if (element.type === 'file') {
                    validateFileInput(element);
                } else if (element.type === 'checkbox') {
                    // Handle checkbox validation immediately without delay
                    if (element.id === 'agreeTerms' || element.id === 'hostCommitment') {
                        // Validate individual required checkboxes
                        if (element.checked) {
                            showFieldSuccess(element);
                        } else {
                            showFieldError(element, element.id === 'agreeTerms' ? 'Bạn phải đồng ý với điều khoản dịch vụ' : 'Bạn phải cam kết tuân thủ tiêu chuẩn');
                        }
                    }
                    // Don't call validateCheckboxes() here as it conflicts with form submission
                }
            });

            // Enhanced form submission validation
            form.addEventListener('submit', function (event) {
                let allFieldsValid = true;
                let firstInvalidElement = null;
                let emptyRequiredFields = [];
                let invalidFields = [];

                // Comprehensive check of all critical fields regardless of required attribute
                const criticalFields = [
                    { id: 'hotelName', label: 'Tên khách sạn' },
                    { id: 'hotelDescription', label: 'Mô tả khách sạn' },
                    { id: 'hotelAddress', label: 'Địa chỉ khách sạn' },
                    { id: 'hotelLocation', label: 'Khu vực/Địa điểm' },
                    { id: 'hotelLatitudeManual', label: 'Vĩ độ' },
                    { id: 'hotelLongitudeManual', label: 'Kinh độ' },
                    { id: 'roomTitle', label: 'Tên phòng' },
                    { id: 'roomMaxGuests', label: 'Số khách tối đa' },
                    { id: 'roomQuantity', label: 'Số lượng phòng' },
                    { id: 'roomPrice', label: 'Giá phòng' },
                    { id: 'roomDescription', label: 'Mô tả phòng' },
                    { id: 'hotelPolicies', label: 'Quy định khách sạn' },
                    { id: 'partialRefundDays', label: 'Số ngày hoàn tiền một phần' },
                    { id: 'partialRefundPercent', label: 'Phần trăm hoàn tiền' },
                    { id: 'noRefundWithinDays', label: 'Số ngày không hoàn tiền' }
                ];

                // Check all critical fields
                criticalFields.forEach(function(fieldInfo) {
                    const element = document.getElementById(fieldInfo.id);
                    if (element) {
                        if (element.type === 'text' || element.type === 'number' || element.tagName === 'TEXTAREA') {
                            if (element.value.trim() === '') {
                                emptyRequiredFields.push(fieldInfo.label);
                                showFieldError(element, `${fieldInfo.label} là bắt buộc`);
                                allFieldsValid = false;
                                if (!firstInvalidElement) firstInvalidElement = element;
                            } else if (!validateField(element)) {
                                invalidFields.push(fieldInfo.label);
                                allFieldsValid = false;
                                if (!firstInvalidElement) firstInvalidElement = element;
                            }
                        } else if (element.tagName === 'SELECT') {
                            if (element.value === '' || element.value === null) {
                                emptyRequiredFields.push(fieldInfo.label);
                                showFieldError(element, `Vui lòng chọn ${fieldInfo.label}`);
                                allFieldsValid = false;
                                if (!firstInvalidElement) firstInvalidElement = element;
                            }
                        }
                    }
                });

                // Check additional required fields that might not be in the critical list
                form.querySelectorAll('input[required], textarea[required], select[required]').forEach(function (element) {
                    const fieldLabel = element.closest('.col-12, .col-md-6, .col-md')?.querySelector('label')?.textContent?.replace('*', '').trim() || element.placeholder || element.name || element.id;

                    // Skip if already checked in critical fields
                    const alreadyChecked = criticalFields.some(field => field.id === element.id);
                    if (!alreadyChecked) {
                        // Skip checkboxes - they are handled separately below
                        if (element.type === 'checkbox') {
                            return; // Skip checkbox validation in this loop
                        }

                        if (element.tagName === 'SELECT') {
                            if (element.value === '' || element.value === null) {
                                emptyRequiredFields.push(fieldLabel);
                                showFieldError(element, `Vui lòng chọn ${fieldLabel}`);
                                allFieldsValid = false;
                                if (!firstInvalidElement) firstInvalidElement = element;
                            }
                        } else if (element.value.trim() === '') {
                            emptyRequiredFields.push(fieldLabel);
                            showFieldError(element, `${fieldLabel} là bắt buộc`);
                            allFieldsValid = false;
                            if (!firstInvalidElement) firstInvalidElement = element;
                        } else if (!validateField(element)) {
                            invalidFields.push(fieldLabel);
                            allFieldsValid = false;
                            if (!firstInvalidElement) firstInvalidElement = element;
                        }
                    }
                });

                // Check required file inputs using the proper image validation function
                const imageValidation = validateImageUploads();
                if (!imageValidation.hotelImageValid) {
                    emptyRequiredFields.push('Ảnh đại diện khách sạn');
                    const hotelImageInput = document.getElementById('hotelImageUpload');
                    showFieldError(hotelImageInput, 'Vui lòng tải lên ảnh khách sạn');
                    allFieldsValid = false;
                    if (!firstInvalidElement) firstInvalidElement = hotelImageInput;
                }

                if (!imageValidation.roomImagesValid) {
                    const roomImageInput = document.getElementById('roomImageUpload');
                    if (imageValidation.roomImagesCount < imageValidation.minRoomImages) {
                        emptyRequiredFields.push(`Hình ảnh phòng (tối thiểu ${imageValidation.minRoomImages} ảnh)`);
                    } else if (imageValidation.roomImagesCount > imageValidation.maxRoomImages) {
                        invalidFields.push(`Hình ảnh phòng (vượt quá ${imageValidation.maxRoomImages} ảnh)`);
                    }
                    showFieldError(roomImageInput, imageValidation.roomImagesErrorMessage);
                    allFieldsValid = false;
                    if (!firstInvalidElement) firstInvalidElement = roomImageInput;
                }

                // Check required checkboxes
                const agreeTerms = document.getElementById('agreeTerms');
                const hostCommitment = document.getElementById('hostCommitment');

                if (agreeTerms && !agreeTerms.checked) {
                    emptyRequiredFields.push('Đồng ý điều khoản dịch vụ');
                    showFieldError(agreeTerms, 'Bạn phải đồng ý với điều khoản dịch vụ');
                    allFieldsValid = false;
                    if (!firstInvalidElement) firstInvalidElement = agreeTerms;
                }

                if (hostCommitment && !hostCommitment.checked) {
                    emptyRequiredFields.push('Cam kết tuân thủ tiêu chuẩn');
                    showFieldError(hostCommitment, 'Bạn phải cam kết tuân thủ tiêu chuẩn');
                    allFieldsValid = false;
                    if (!firstInvalidElement) firstInvalidElement = hostCommitment;
                }

                // Check amenities selection
                const amenityCheckboxes = document.querySelectorAll('input[name="amenities"]:checked');
                if (amenityCheckboxes.length === 0) {
                    emptyRequiredFields.push('Tiện nghi phòng (chọn ít nhất 1)');
                    const firstAmenityCheckbox = document.querySelector('input[name="amenities"]');
                    if (firstAmenityCheckbox) {
                        showFieldError(firstAmenityCheckbox.parentNode, 'Vui lòng chọn ít nhất một tiện nghi');
                        allFieldsValid = false;
                        if (!firstInvalidElement) firstInvalidElement = firstAmenityCheckbox;
                    }
                }

                // *** CRITICAL: Validate cancellation policy logic ***
                const partialDaysField = document.getElementById('partialRefundDays');
                const refundPercentField = document.getElementById('partialRefundPercent');
                const noDaysField = document.getElementById('noRefundWithinDays');

                if (partialDaysField && refundPercentField && noDaysField) {
                    const partialDays = parseInt(partialDaysField.value) || 0;
                    const refundPercent = parseInt(refundPercentField.value) || 0;
                    const noDays = parseInt(noDaysField.value) || 0;

                    // Validate ranges
                    if (partialDays < 1 || partialDays > 365) {
                        emptyRequiredFields.push('Số ngày hoàn tiền một phần (1-365 ngày)');
                        showFieldError(partialDaysField, 'Số ngày phải từ 1 đến 365');
                        allFieldsValid = false;
                        if (!firstInvalidElement) firstInvalidElement = partialDaysField;
                    }

                    if (refundPercent < 10 || refundPercent > 100) {
                        emptyRequiredFields.push('Phần trăm hoàn tiền (10-100%)');
                        showFieldError(refundPercentField, 'Phần trăm hoàn tiền phải từ 10% đến 100%');
                        allFieldsValid = false;
                        if (!firstInvalidElement) firstInvalidElement = refundPercentField;
                    }

                    if (noDays < 0 || noDays > 365) {
                        emptyRequiredFields.push('Số ngày không hoàn tiền (0-365 ngày)');
                        showFieldError(noDaysField, 'Số ngày phải từ 0 đến 365');
                        allFieldsValid = false;
                        if (!firstInvalidElement) firstInvalidElement = noDaysField;
                    }

                    // *** CRITICAL: Logic validation - no refund days must be < partial refund days ***
                    if (noDays >= partialDays) {
                        emptyRequiredFields.push('Logic chính sách hoàn tiền không hợp lệ');
                        showFieldError(noDaysField, 'Số ngày không hoàn tiền phải nhỏ hơn số ngày hoàn tiền một phần');
                        allFieldsValid = false;
                        if (!firstInvalidElement) firstInvalidElement = noDaysField;
                    }
                }

                // Always prevent submission if not valid
                if (!allFieldsValid) {
                    event.preventDefault();

                    // Create detailed notification message
                    let notificationTitle = '';
                    let notificationMessage = '';

                    if (emptyRequiredFields.length > 0 && invalidFields.length > 0) {
                        notificationTitle = 'Thông tin chưa đầy đủ!';
                        notificationMessage = `Các trường bắt buộc chưa điền: ${emptyRequiredFields.join(', ')}. Các trường không hợp lệ: ${invalidFields.join(', ')}.`;
                    } else if (emptyRequiredFields.length > 0) {
                        notificationTitle = 'Thiếu thông tin bắt buộc!';
                        notificationMessage = `Vui lòng điền đầy đủ các trường sau: ${emptyRequiredFields.join(', ')}.`;
                    } else if (invalidFields.length > 0) {
                        notificationTitle = 'Thông tin không hợp lệ!';
                        notificationMessage = `Vui lòng kiểm tra lại các trường sau: ${invalidFields.join(', ')}.`;
                    } else {
                        // Fallback notification - this should catch cases where validation fails but no specific errors were identified
                        notificationTitle = 'Không thể gửi biểu mẫu!';
                        notificationMessage = 'Vui lòng kiểm tra và hoàn thành tất cả các trường bắt buộc. Đảm bảo rằng bạn đã điền đầy đủ thông tin khách sạn, thông tin phòng, tải lên hình ảnh và đồng ý với các điều khoản.';
                    }

                    showErrorNotification(
                        notificationTitle,
                        notificationMessage,
                        10000
                    );

                    if (firstInvalidElement) {
                        // Navigate to step containing the invalid element
                        let stepPane = firstInvalidElement.closest('.content.fade');
                        if (stepper && stepPane && !stepPane.classList.contains('active')) {
                            const stepId = stepPane.id;
                            const stepperHeader = document.querySelector(`.bs-stepper-header .step[data-target="#${stepId}"]`);
                            if (stepperHeader) {
                                const steps = Array.from(document.querySelectorAll('.bs-stepper-header .step'));
                                const stepIndex = steps.indexOf(stepperHeader);
                                if (stepIndex !== -1 && typeof stepper.to === 'function') {
                                    stepper.to(stepIndex + 1);
                                }
                            }
                        }

                        // Focus and scroll to first invalid element
                        setTimeout(() => {
                            firstInvalidElement.focus();
                            firstInvalidElement.scrollIntoView({behavior: 'smooth', block: 'center'});

                            // Add enhanced visual emphasis
                            firstInvalidElement.classList.add('focus-highlight', 'shake-enhanced');

                            // Remove highlight after a few seconds
                            setTimeout(() => {
                                firstInvalidElement.classList.remove('focus-highlight', 'shake-enhanced');
                            }, 4000);

                            // Show additional notification about navigation
                            setTimeout(() => {
                                showWarningNotification(
                                    'Đã điều hướng!',
                                    'Đã di chuyển đến trường đầu tiên cần điền. Vui lòng hoàn thành thông tin.',
                                    3000
                                );
                            }, 1000);
                        }, 500);
                    } else {
                        // If no specific invalid element found, show general guidance
                        showWarningNotification(
                            'Cần kiểm tra!',
                            'Vui lòng xem lại tất cả các bước và đảm bảo đã hoàn thành đầy đủ thông tin.',
                            5000
                        );
                    }
                } else {
                    // Show single submission notification
                    showSuccessNotification(
                        'Đang gửi thông tin...',
                        'Vui lòng chờ trong giây lát.'
                    );

                    // Mark final step as completed
                    markStepAsCompleted(3);
                }
            });
        }

        // next button - restore step validation
        const nextButtons = document.querySelectorAll('.next-btn');
        nextButtons.forEach(button => {
            button.addEventListener('click', function (event) {
                // Determine current step and validate accordingly
                let currentStepValid = true;
                const currentStep = document.querySelector('.content.fade.active') || document.querySelector('.content.fade.dstepper-block');

                if (currentStep) {
                    if (currentStep.id === 'step-hotel-1') {
                        currentStepValid = validateCurrentStepFields(1);
                    } else if (currentStep.id === 'step-hotel-2') {
                        currentStepValid = validateCurrentStepFields(2);
                    } else if (currentStep.id === 'step-hotel-3') {
                        currentStepValid = validateCurrentStepFields(3);
                    }
                }

                if (!currentStepValid) {
                    event.preventDefault();
                    event.stopPropagation();
                    return false;
                } else {
                    // Mark current step as completed
                    if (currentStep.id === 'step-hotel-1') {
                        markStepAsCompleted(1);
                    } else if (currentStep.id === 'step-hotel-2') {
                        markStepAsCompleted(2);
                    } else if (currentStep.id === 'step-hotel-3') {
                        markStepAsCompleted(3);
                    }
                }

                if (stepper) {
                    stepper.next();
                }
            });
        });

        // Step validation function
        function validateCurrentStepFields(stepNumber) {
            let isValid = true;
            let emptyFields = [];
            let firstInvalidElement = null;

            if (stepNumber === 1) {
                // Step 1 validation
                const step1Fields = [
                    { id: 'hotelName', label: 'Tên khách sạn' },
                    { id: 'hotelDescription', label: 'Mô tả khách sạn' },
                    { id: 'hotelAddress', label: 'Địa chỉ khách sạn' },
                    { id: 'hotelLocation', label: 'Khu vực/Địa điểm' },
                    { id: 'hotelLatitudeManual', label: 'Vĩ độ' },
                    { id: 'hotelLongitudeManual', label: 'Kinh độ' }
                ];

                step1Fields.forEach(function(fieldInfo) {
                    const element = document.getElementById(fieldInfo.id);
                    if (element) {
                        if (element.tagName === 'SELECT') {
                            if (element.value === '' || element.value === null) {
                                emptyFields.push(fieldInfo.label);
                                showFieldError(element, `Vui lòng chọn ${fieldInfo.label}`);
                                isValid = false;
                                if (!firstInvalidElement) firstInvalidElement = element;
                            }
                        } else if (element.value.trim() === '') {
                            emptyFields.push(fieldInfo.label);
                            showFieldError(element, `${fieldInfo.label} là bắt buộc`);
                            isValid = false;
                            if (!firstInvalidElement) firstInvalidElement = element;
                        } else if (!validateField(element)) {
                            isValid = false;
                            if (!firstInvalidElement) firstInvalidElement = element;
                        }
                    }
                });

                // Check hotel image
                const imageValidation = validateImageUploads();
                if (!imageValidation.hotelImageValid) {
                    emptyFields.push('Ảnh đại diện khách sạn');
                    const hotelImageInput = document.getElementById('hotelImageUpload');
                    showFieldError(hotelImageInput, 'Vui lòng tải lên ảnh khách sạn');
                    isValid = false;
                    if (!firstInvalidElement) firstInvalidElement = hotelImageInput;
                }

                if (!isValid) {
                    showErrorNotification(
                        'Bước 1 chưa hoàn tất!',
                        `Vui lòng hoàn thành các thông tin sau: ${emptyFields.join(', ')}.`,
                        8000
                    );
                }

            } else             if (stepNumber === 2) {
                // Step 2 validation
                const step2Fields = [
                    { id: 'roomTitle', label: 'Tên phòng' },
                    { id: 'roomMaxGuests', label: 'Số khách tối đa' },
                    { id: 'roomQuantity', label: 'Số lượng phòng' },
                    { id: 'roomPrice', label: 'Giá phòng' },
                    { id: 'roomDescription', label: 'Mô tả phòng' }
                ];

                step2Fields.forEach(function(fieldInfo) {
                    const element = document.getElementById(fieldInfo.id);
                    if (element) {
                        if (element.tagName === 'SELECT') {
                            if (element.value === '' || element.value === null) {
                                emptyFields.push(fieldInfo.label);
                                showFieldError(element, `Vui lòng chọn ${fieldInfo.label}`);
                                isValid = false;
                                if (!firstInvalidElement) firstInvalidElement = element;
                            }
                        } else if (element.value.trim() === '') {
                            emptyFields.push(fieldInfo.label);
                            showFieldError(element, `${fieldInfo.label} là bắt buộc`);
                            isValid = false;
                            if (!firstInvalidElement) firstInvalidElement = element;
                        } else if (!validateField(element)) {
                            isValid = false;
                            if (!firstInvalidElement) firstInvalidElement = element;
                        }
                    }
                });

                // Check room images
                const imageValidation = validateImageUploads();
                if (!imageValidation.roomImagesValid) {
                    const roomImageInput = document.getElementById('roomImageUpload');
                    if (imageValidation.roomImagesCount < imageValidation.minRoomImages) {
                        emptyFields.push(`Hình ảnh phòng (tối thiểu ${imageValidation.minRoomImages} ảnh)`);
                    } else if (imageValidation.roomImagesCount > imageValidation.maxRoomImages) {
                        emptyFields.push(`Hình ảnh phòng (vượt quá ${imageValidation.maxRoomImages} ảnh)`);
                    }
                    showFieldError(roomImageInput, imageValidation.roomImagesErrorMessage);
                    isValid = false;
                    if (!firstInvalidElement) firstInvalidElement = roomImageInput;
                }

                // Check amenities selection
                const amenityCheckboxes = document.querySelectorAll('input[name="amenities"]:checked');
                if (amenityCheckboxes.length === 0) {
                    emptyFields.push('Tiện nghi phòng (chọn ít nhất 1)');
                    const firstAmenityCheckbox = document.querySelector('input[name="amenities"]');
                    if (firstAmenityCheckbox) {
                        showFieldError(firstAmenityCheckbox.parentNode, 'Vui lòng chọn ít nhất một tiện nghi');
                        isValid = false;
                        if (!firstInvalidElement) firstInvalidElement = firstAmenityCheckbox;
                    }
                }

                if (!isValid) {
                    showErrorNotification(
                        'Bước 2 chưa hoàn tất!',
                        `Vui lòng hoàn thành các thông tin sau: ${emptyFields.join(', ')}.`,
                        8000
                    );
                }
            } else if (stepNumber === 3) {
                // Step 3 validation - Policies and cancellation policy
                const step3Fields = [
                    { id: 'hotelPolicies', label: 'Nội quy khách sạn' },
                    { id: 'partialRefundDays', label: 'Số ngày hoàn tiền một phần' },
                    { id: 'partialRefundPercent', label: 'Phần trăm hoàn tiền' },
                    { id: 'noRefundWithinDays', label: 'Số ngày không hoàn tiền' }
                ];

                step3Fields.forEach(function(fieldInfo) {
                    const element = document.getElementById(fieldInfo.id);
                    if (element) {
                        if (element.value.trim() === '') {
                            emptyFields.push(fieldInfo.label);
                            showFieldError(element, `${fieldInfo.label} là bắt buộc`);
                            isValid = false;
                            if (!firstInvalidElement) firstInvalidElement = element;
                        } else if (!validateField(element)) {
                            isValid = false;
                            if (!firstInvalidElement) firstInvalidElement = element;
                        }
                    }
                });

                // Validate cancellation policy logic
                const partialDays = parseInt(document.getElementById('partialRefundDays').value) || 0;
                const refundPercent = parseInt(document.getElementById('partialRefundPercent').value) || 0;
                const noDays = parseInt(document.getElementById('noRefundWithinDays').value) || 0;

                if (partialDays < 1 || partialDays > 365) {
                    emptyFields.push('Số ngày hoàn tiền một phần (1-365 ngày)');
                    showFieldError(document.getElementById('partialRefundDays'), 'Số ngày phải từ 1 đến 365');
                    isValid = false;
                    if (!firstInvalidElement) firstInvalidElement = document.getElementById('partialRefundDays');
                }

                if (refundPercent < 10 || refundPercent > 100) {
                    emptyFields.push('Phần trăm hoàn tiền (10-100%)');
                    showFieldError(document.getElementById('partialRefundPercent'), 'Phần trăm hoàn tiền phải từ 10% đến 100%');
                    isValid = false;
                    if (!firstInvalidElement) firstInvalidElement = document.getElementById('partialRefundPercent');
                }

                if (noDays < 0 || noDays > 365) {
                    emptyFields.push('Số ngày không hoàn tiền (0-365 ngày)');
                    showFieldError(document.getElementById('noRefundWithinDays'), 'Số ngày phải từ 0 đến 365');
                    isValid = false;
                    if (!firstInvalidElement) firstInvalidElement = document.getElementById('noRefundWithinDays');
                }

                if (noDays >= partialDays) {
                    emptyFields.push('Logic chính sách hoàn tiền');
                    showFieldError(document.getElementById('noRefundWithinDays'), 'Số ngày không hoàn tiền phải nhỏ hơn số ngày hoàn tiền một phần');
                    isValid = false;
                    if (!firstInvalidElement) firstInvalidElement = document.getElementById('noRefundWithinDays');
                }

                // Check required checkboxes
                const agreeTerms = document.getElementById('agreeTerms');
                const hostCommitment = document.getElementById('hostCommitment');
                
                if (!agreeTerms.checked) {
                    emptyFields.push('Đồng ý điều khoản dịch vụ');
                    showFieldError(agreeTerms.parentNode, 'Vui lòng đồng ý với điều khoản dịch vụ');
                    isValid = false;
                    if (!firstInvalidElement) firstInvalidElement = agreeTerms;
                }

                if (!hostCommitment.checked) {
                    emptyFields.push('Cam kết chủ khách sạn');
                    showFieldError(hostCommitment.parentNode, 'Vui lòng xác nhận cam kết chủ khách sạn');
                    isValid = false;
                    if (!firstInvalidElement) firstInvalidElement = hostCommitment;
                }

                if (!isValid) {
                    showErrorNotification(
                        'Bước 3 chưa hoàn tất!',
                        `Vui lòng hoàn thành các thông tin sau: ${emptyFields.join(', ')}.`,
                        8000
                    );
                }
            }

            if (!isValid && firstInvalidElement) {
                setTimeout(() => {
                    firstInvalidElement.focus();
                    firstInvalidElement.scrollIntoView({behavior: 'smooth', block: 'center'});
                    firstInvalidElement.classList.add('focus-highlight', 'shake-enhanced');
                    setTimeout(() => {
                        firstInvalidElement.classList.remove('focus-highlight', 'shake-enhanced');
                    }, 4000);
                }, 300);
            }

            return isValid;
        }

        // Function to mark step as completed
        function markStepAsCompleted(stepNumber) {
            const stepTrigger = document.getElementById(`stepperHotelTrigger${stepNumber}`);
            if (stepTrigger) {
                const circle = stepTrigger.querySelector('.bs-stepper-circle');
                if (circle && !circle.classList.contains('completed')) {
                    circle.classList.add('completed');
                    circle.style.backgroundColor = '#198754';
                    circle.style.color = 'white';


                }
            }
        }

        // back button
        const prevButtons = document.querySelectorAll('.prev-btn');
        prevButtons.forEach(button => {
            button.addEventListener('click', function () {
                if (stepper) {
                    stepper.previous();
                }
            });
        });

        const reviewStepTrigger = document.getElementById('stepperHotelTrigger3');
        if (reviewStepTrigger) {
            reviewStepTrigger.addEventListener('click', updateSummary);
        }

        if (document.querySelector('#step-hotel-3.active') || (stepper && stepper._currentIndex === 2)) {
            updateSummary();
        }

        // Control step header button clicks - prevent skipping ahead
        function controlStepHeaderButtons() {
            const stepTriggers = document.querySelectorAll('.step-trigger');

            stepTriggers.forEach((trigger, index) => {
                trigger.addEventListener('click', function(event) {
                    const currentStepIndex = getCurrentStepIndex();
                    const targetStepIndex = index; // 0-based: 0=step1, 1=step2, 2=step3

                    // Allow going backwards (to review completed steps)
                    if (targetStepIndex <= currentStepIndex) {
                        return; // Allow the click
                    }

                    // Check if target step is unlocked
                    const targetStepNumber = targetStepIndex + 1;
                    const targetStepCompleted = isStepCompleted(targetStepNumber - 1); // Check if previous step is completed

                    if (!targetStepCompleted && targetStepIndex > currentStepIndex) {
                        event.preventDefault();
                        event.stopPropagation();

                        showWarningNotification(
                            'Không thể bỏ qua bước!',
                            `Vui lòng hoàn thành bước ${currentStepIndex + 1} trước khi chuyển đến bước ${targetStepNumber}.`,
                            5000
                        );

                        return false;
                    }
                });
            });
        }

        function getCurrentStepIndex() {
            const activeStep = document.querySelector('.content.fade.active') || document.querySelector('.content.fade.dstepper-block');
            if (!activeStep) return 0;

            if (activeStep.id === 'step-hotel-1') return 0;
            if (activeStep.id === 'step-hotel-2') return 1;
            if (activeStep.id === 'step-hotel-3') return 2;
            return 0;
        }

        function isStepCompleted(stepNumber) {
            if (stepNumber === 0) return true; // Step 1 is always accessible

            const stepTrigger = document.getElementById(`stepperHotelTrigger${stepNumber}`);
            if (stepTrigger) {
                const circle = stepTrigger.querySelector('.bs-stepper-circle');
                return circle && circle.classList.contains('completed');
            }
            return false;
        }

        // Initialize step control
        // controlStepHeaderButtons(); // Disabled - step buttons are disabled via CSS

        // --- End of Enhanced Form Validation Logic ---

        // HOTFIX: Override checkbox validation to prevent conflicts
        const formElement = document.getElementById('registerHostForm');
        if (formElement) {
            formElement.addEventListener('submit', function(event) {
                // Clear any existing checkbox errors first
                const agreeTermsElement = document.getElementById('agreeTerms');
                const hostCommitmentElement = document.getElementById('hostCommitment');

                if (agreeTermsElement) {
                    removeFieldError(agreeTermsElement);
                }
                if (hostCommitmentElement) {
                    removeFieldError(hostCommitmentElement);
                }

                // Simple validation - if both are checked, remove any errors
                if (agreeTermsElement && agreeTermsElement.checked && hostCommitmentElement && hostCommitmentElement.checked) {
                    // Both checkboxes are checked - show success state
                    showFieldSuccess(agreeTermsElement);
                    showFieldSuccess(hostCommitmentElement);
                }
            }, true); // Use capture phase to run before the main validation
        }

        // --- Draft Management Initialization ---
        loadDraftsList();

        // Auto-load draft from URL parameter if it exists
        const urlParams = new URLSearchParams(window.location.search);
        const loadDraftId = urlParams.get('loadDraft');
        if (loadDraftId) {
            // A small timeout ensures Choices.js and other components are fully rendered
            setTimeout(() => {
                loadDraftFromLocalStorage(loadDraftId);
            }, 100);
        }
    });

    // Notification System (Moved to Global Scope)
    function showNotification(type, title, message, duration = 5000) {
        const container = document.getElementById('notificationContainer');

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;

        notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">×</button>
            `;

        container.appendChild(notification);

        // Trigger animation
        setTimeout(() => {
            notification.classList.add('show');
        }, 100);

        // Auto remove after duration
        setTimeout(() => {
            if (notification.parentElement) {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }
        }, duration);
    }

    function showErrorNotification(title, message = '') {
        const notification = document.getElementById('notification');
        const notificationTitle = document.getElementById('notificationTitle');
        const notificationMessage = document.getElementById('notificationMessage');
        
        notificationTitle.textContent = title;
        notificationMessage.textContent = message;
        
        notification.className = 'notification error show';
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 5000);
    }

    function showSuccessNotification(title, message) {
        showNotification('success', title, message);
    }

        function showWarningNotification(title, message = '') {
        const notification = document.getElementById('notification');
        const notificationTitle = document.getElementById('notificationTitle');
        const notificationMessage = document.getElementById('notificationMessage');
        
        notificationTitle.textContent = title;
        notificationMessage.textContent = message;
        
        notification.className = 'notification warning show';
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 5000);
    }
    
    // Helper function to get the selected location text
    function getSelectedLocationText() {
        const selectElement = document.getElementById('hotelLocation');
        if (selectElement && selectElement.value) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            return selectedOption ? selectedOption.text : '';
        }
        return '';
    }
</script>

<!--hotel image upload-->
<script>
    const dropzone = document.getElementById("hotelMainImage");
    const fileInput = document.getElementById("hotelImageUpload");
    const previewImage = document.getElementById("imagePreview");
    const hiddenInput = document.getElementById("imageUrl");

    let currentFile = null;

    // Prevent default drag behaviors
    ["dragenter", "dragover", "dragleave", "drop"].forEach(eventName => {
        dropzone.addEventListener(eventName, e => e.preventDefault());
    });

    dropzone.addEventListener("dragover", () => {
        dropzone.classList.add("dragover");
    });

    dropzone.addEventListener("dragleave", () => {
        dropzone.classList.remove("dragover");
    });

    dropzone.addEventListener("drop", (e) => {
        dropzone.classList.remove("dragover");
        const file = e.dataTransfer.files[0];
        if (file) handleFile(file);
    });

    fileInput.addEventListener("change", () => {
        const file = fileInput.files[0];
        if (file) handleFile(file);
    });

    function handleFile(file) {
        const validTypes = ["image/jpeg", "image/png", "image/webp", "image/gif"];
        if (!validTypes.includes(file.type)) {
            alert("Chỉ chấp nhận ảnh JPG, PNG, GIF hoặc WEBP.");
            return;
        }

        currentFile = file;
        hiddenInput.value = ""; // clear existing URL

        // CRITICAL FIX: Set the file in the actual form input for submission
        const dt = new DataTransfer();
        dt.items.add(file);
        fileInput.files = dt.files;

        // Set global flag for image upload tracking
        hotelImageUploaded = true;
        window.hotelImageUploaded = true; // Also set on window for validation access

        const reader = new FileReader();
        reader.onload = function (e) {
            previewImage.src = e.target.result;
            previewImage.style.display = "block";

            // Add delete button if not already added
            if (!document.getElementById("deleteImageBtn")) {
                const deleteBtn = document.createElement("button");
                deleteBtn.type = "button";
                deleteBtn.textContent = "Xóa ảnh";
                deleteBtn.className = "btn btn-danger btn-sm mt-2";
                deleteBtn.id = "deleteImageBtn";
                deleteBtn.onclick = () => {
                    previewImage.src = "";
                    previewImage.style.display = "none";
                    fileInput.value = "";
                    hiddenInput.value = "";
                    hotelImageUploaded = false; // Reset flag when image is deleted
                    window.hotelImageUploaded = false; // Also reset window flag
                    deleteBtn.remove();
                };
                previewImage.insertAdjacentElement("afterend", deleteBtn);
            }
        };
        reader.readAsDataURL(file);
    }
</script>

<!--room image upload-->
<script>
    const dropzoneRoom = document.getElementById("roomImages");
    const fileInputRoom = document.getElementById("roomImageUpload");
    const previewContainer = document.getElementById("roomImagePreviewContainer");

    let fileList = [];

    // Prevent default behavior
    ["dragenter", "dragover", "dragleave", "drop"].forEach(eventName => {
        dropzoneRoom.addEventListener(eventName, e => e.preventDefault());
    });

    dropzoneRoom.addEventListener("dragover", () => {
        dropzoneRoom.classList.add("dragover");
    });

    dropzoneRoom.addEventListener("dragleave", () => {
        dropzoneRoom.classList.remove("dragover");
    });

    dropzoneRoom.addEventListener("drop", (e) => {
        dropzoneRoom.classList.remove("dragover");
        addFiles(Array.from(e.dataTransfer.files));
    });

    fileInputRoom.addEventListener("change", () => {
        addFiles(Array.from(fileInputRoom.files));
    });

    function addFiles(newFiles) {
        const validTypes = ["image/jpeg", "image/png", "image/webp", "image/gif"];
        const maxImages = 5;
        let validFilesToAdd = [];
        
        newFiles.forEach(file => {
            if (!validTypes.includes(file.type)) {
                alert("Không chấp nhận file: " + file.name + ". Chỉ chấp nhận ảnh JPG, PNG, GIF hoặc WEBP.");
                return;
            }
            
            if (fileList.length + validFilesToAdd.length < maxImages) {
                validFilesToAdd.push(file);
            }
        });
        
        // Check if we're trying to add too many files
        if (fileList.length + validFilesToAdd.length > maxImages) {
            const remainingSlots = maxImages - fileList.length;
            if (remainingSlots > 0) {
                validFilesToAdd = validFilesToAdd.slice(0, remainingSlots);
                alert(`Chỉ có thể tải lên tối đa ${maxImages} ảnh. Đã thêm ${remainingSlots} ảnh đầu tiên.`);
            } else {
                alert(`Đã đạt giới hạn tối đa ${maxImages} ảnh. Vui lòng xóa bớt ảnh hiện tại trước khi thêm ảnh mới.`);
                return;
            }
        }
        
        if (fileList.length + newFiles.length > maxImages) {
            const totalAttempted = fileList.length + newFiles.length;
            alert(`Không thể thêm tất cả ảnh. Bạn đang cố thêm ${newFiles.length} ảnh nhưng chỉ còn ${maxImages - fileList.length} vị trí trống (tối đa ${maxImages} ảnh).`);
        }
        
        // Add valid files to the list
        fileList.push(...validFilesToAdd);

        // Update global room images count
        roomImagesCount = fileList.length;
        window.roomImagesCount = fileList.length; // Also set on window for validation access

        renderPreviews();
        updateInputFiles();
        

    }

    function renderPreviews() {
        previewContainer.innerHTML = "";
        fileList.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function (e) {
                const wrapper = document.createElement("div");
                wrapper.classList.add("position-relative");

                const img = document.createElement("img");
                img.src = e.target.result;
                img.style.maxWidth = "150px";
                img.classList.add("rounded");

                const deleteBtn = document.createElement("button");
                deleteBtn.type = "button";
                deleteBtn.innerHTML = "&times;";
                deleteBtn.classList.add("btn", "btn-danger", "btn-sm", "position-absolute", "top-0", "end-0");
                deleteBtn.onclick = () => {
                    fileList.splice(index, 1);
                    roomImagesCount = fileList.length; // Update global count
                    window.roomImagesCount = fileList.length; // Also update window count
                    renderPreviews();
                    updateInputFiles();
                };

                wrapper.appendChild(img);
                wrapper.appendChild(deleteBtn);
                previewContainer.appendChild(wrapper);
            };
            reader.readAsDataURL(file);
        });
    }

    function updateInputFiles() {
        const dt = new DataTransfer();
        fileList.forEach(file => dt.items.add(file));
        fileInputRoom.files = dt.files;
    }
</script>

<!-- LocalStorage Draft Management JavaScript -->
<script>
    // Helper function to read a file as a Data URL (Base64)
    function readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = (error) => reject(error);
            reader.readAsDataURL(file);
        });
    }

    // Helper function to convert Data URL back to a File object
    function dataURLtoFile(dataurl, filename) {
        try {
            var arr = dataurl.split(','),
                mimeMatch = arr[0].match(/:(.*?);/);
            
            if (!mimeMatch) {
                console.error("Invalid data URL format");
                return null;
            }
            
            var mime = mimeMatch[1],
                bstr = atob(arr[arr.length - 1]), // Use arr.length - 1 to be safe
                n = bstr.length,
                u8arr = new Uint8Array(n);
                
            while(n--){
                u8arr[n] = bstr.charCodeAt(n);
            }
            
            return new File([u8arr], filename, {type:mime});
        } catch (e) {
            console.error("Error converting data URL to file:", e);
            return null;
        }
    }

    // Draft management constants
    const DRAFT_STORAGE_KEY = 'hotelRegistrationDrafts';
    const MAX_DRAFTS = 3; // Limit to prevent localStorage bloat
    
    // Initialize draft system on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadDraftsList();
        
        // Auto-load draft from URL parameter if exists
        const urlParams = new URLSearchParams(window.location.search);
        const loadDraftId = urlParams.get('loadDraft');
        if (loadDraftId) {
            loadDraftFromLocalStorage(loadDraftId);
        }
    });
    
    // Show save draft modal
    function showSaveDraftModal() {
        console.log('showSaveDraftModal called'); // Debug log
        const modal = new bootstrap.Modal(document.getElementById('saveDraftModal'));
        modal.show();
        
        // Generate default name with timestamp
        const now = new Date();
        const defaultName = `Nháp khách sạn ${now.getDate()}/${now.getMonth() + 1}/${now.getFullYear()} ${now.getHours()}:${now.getMinutes()}`;
        document.getElementById('draftNameInput').value = defaultName;
        console.log('Modal should be showing now'); // Debug log
    }
    
    // Save draft to localStorage
    async function saveDraftToLocalStorage() {
        console.log('saveDraftToLocalStorage called'); // Debug log
        const draftName = document.getElementById('draftNameInput').value.trim();
        console.log('Draft name:', draftName); // Debug log
        
        if (!draftName) {
            console.log('No draft name provided'); // Debug log
            showErrorNotification('Thiếu thông tin!', 'Vui lòng nhập tên cho bản nháp');
            return;
        }
        
        // Collect all form data
        const draftData = {
            id: Date.now().toString(), // Simple ID based on timestamp
            name: draftName,
            timestamp: new Date().toISOString(),
            data: {
                // Hotel information
                hotelName: document.getElementById('hotelName').value,
                hotelDescription: document.getElementById('hotelDescription').value,
                hotelAddress: document.getElementById('hotelAddress').value,
                hotelLocation: document.getElementById('hotelLocation').value, // This gets the selected value
                hotelLocationText: getSelectedLocationText(), // Store the text as well for restoration
                hotelLatitude: document.getElementById('hotelLatitudeManual').value,
                hotelLongitude: document.getElementById('hotelLongitudeManual').value,
                hotelPolicies: document.getElementById('hotelPolicies').value,
                
                // Room information
                roomTitle: document.getElementById('roomTitle').value,
                roomMaxGuests: document.getElementById('roomMaxGuests').value,
                roomQuantity: document.getElementById('roomQuantity').value,
                roomPrice: document.getElementById('roomPrice').value,
                roomDescription: document.getElementById('roomDescription').value,
                
                // Cancellation policy
                partialRefundDays: document.getElementById('partialRefundDays').value,
                partialRefundPercent: document.getElementById('partialRefundPercent').value,
                noRefundWithinDays: document.getElementById('noRefundWithinDays').value,
                
                // Amenities (selected checkboxes)
                amenities: Array.from(document.querySelectorAll('input[name="amenities"]:checked')).map(cb => cb.value),
                
                // Image data will be populated asynchronously
                hotelImage: null,
                roomImages: []
            }
        };
        
        // Handle hotel image
        const hotelImageFile = document.getElementById('hotelImageUpload').files[0];
        if (hotelImageFile) {
            try {
                draftData.data.hotelImage = await readFileAsDataURL(hotelImageFile);
            } catch (e) {
                console.error("Error reading hotel image file:", e);
            }
        }

        // Handle room images (using the global fileList from the room image script)
        if (typeof fileList !== 'undefined' && fileList.length > 0) {
            try {
                draftData.data.roomImages = await Promise.all(fileList.map(file => readFileAsDataURL(file)));
            } catch (e) {
                console.error("Error reading room image files:", e);
            }
        }
        
        // Get existing drafts
        const existingDrafts = getDraftsFromStorage();
        
        // Check if we're at max capacity and remove oldest if needed
        if (existingDrafts.length >= MAX_DRAFTS) {
            existingDrafts.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            existingDrafts.splice(0, existingDrafts.length - MAX_DRAFTS + 1);
        }
        
        // Add new draft
        existingDrafts.push(draftData);
        
        // Save to localStorage
        try {
            localStorage.setItem(DRAFT_STORAGE_KEY, JSON.stringify(existingDrafts));
            
            showSuccessNotification('Lưu nháp thành công!', `Đã lưu nháp "${draftName}" vào bộ nhớ trình duyệt`);
            
            // Close modal and refresh draft list
            const modal = bootstrap.Modal.getInstance(document.getElementById('saveDraftModal'));
            modal.hide();
            
            loadDraftsList();
            
        } catch (error) {
            console.error('Error saving draft:', error);
            showErrorNotification('Lỗi lưu nháp!', 'Không thể lưu nháp. Có thể bộ nhớ trình duyệt đã đầy.');
        }
    }
    
    // Get drafts from localStorage
    function getDraftsFromStorage() {
        try {
            const drafts = localStorage.getItem(DRAFT_STORAGE_KEY);
            return drafts ? JSON.parse(drafts) : [];
        } catch (error) {
            console.error('Error reading drafts from storage:', error);
            return [];
        }
    }
    
    // Load and display drafts list
    function loadDraftsList() {
        const drafts = getDraftsFromStorage();
        const draftList = document.getElementById('draftList');
        const draftSection = document.getElementById('draftManagementSection');
        
        if (drafts.length === 0) {
            draftSection.style.display = 'none';
            return;
        }
        
        // Show draft section
        draftSection.style.display = 'block';
        
        // Sort drafts by timestamp (newest first)
        drafts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        // Generate HTML for drafts
        draftList.innerHTML = drafts.map(draft => `
            <div class="col-md-6 col-lg-4">
                <div class="card border">
                    <div class="card-body p-3">
                        <h6 class="card-title text-truncate" title="${draft.name}">${draft.name}</h6>
                        <p class="card-text small text-muted mb-2">
                            <i class="bi bi-clock me-1"></i>
                            ${new Date(draft.timestamp).toLocaleString('vi-VN')}
                        </p>
                        <div class="small text-muted mb-2">
                            <div class="text-truncate">
                                <i class="bi bi-building me-1"></i>
                                ${draft.data.hotelName || 'Chưa nhập tên khách sạn'}
                            </div>
                            <div class="text-truncate">
                                <i class="bi bi-door-open me-1"></i>
                                ${draft.data.roomTitle || 'Chưa nhập tên phòng'}
                            </div>
                            <div class="text-truncate">
                                <i class="bi bi-arrow-clockwise me-1"></i>
                                Hoàn tiền: ${draft.data.partialRefundDays || 7} ngày - ${draft.data.partialRefundPercent || 50}%
                            </div>
                        </div>
                        <div class="d-flex gap-1">
                            <button type="button" class="btn btn-sm btn-outline-primary flex-fill" 
                                    onclick="loadDraftFromLocalStorage('${draft.id}')">
                                <i class="bi bi-play me-1"></i>Tiếp tục
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                    onclick="deleteDraftFromLocalStorage('${draft.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    // Load draft data into form
    function loadDraftFromLocalStorage(draftId) {
        console.log('Loading draft:', draftId);
        const drafts = getDraftsFromStorage();
        const draft = drafts.find(d => d.id === draftId);
        
        if (!draft) {
            showErrorNotification('Lỗi tải nháp!', 'Không tìm thấy bản nháp này');
            return;
        }
        
        const data = draft.data;
        console.log('Draft data:', data);
        
        // Build URL with all draft data as parameters
        const params = new URLSearchParams();
        
        // Add all non-image data
        if (data.hotelName) params.append('hotelName', data.hotelName);
        if (data.hotelDescription) params.append('hotelDescription', data.hotelDescription);
        if (data.hotelAddress) params.append('hotelAddress', data.hotelAddress);
        if (data.hotelLocation) params.append('hotelLocation', data.hotelLocation);
        if (data.hotelLocationText) params.append('hotelLocationText', data.hotelLocationText);
        if (data.hotelLatitude) params.append('hotelLatitude', data.hotelLatitude);
        if (data.hotelLongitude) params.append('hotelLongitude', data.hotelLongitude);
        if (data.hotelPolicies) params.append('hotelPolicies', data.hotelPolicies);
        if (data.roomTitle) params.append('roomTitle', data.roomTitle);
        if (data.roomMaxGuests) params.append('roomMaxGuests', data.roomMaxGuests);
        if (data.roomQuantity) params.append('roomQuantity', data.roomQuantity);
        if (data.roomPrice) params.append('roomPrice', data.roomPrice);
        if (data.roomDescription) params.append('roomDescription', data.roomDescription);
        
        // Add cancellation policy data
        if (data.partialRefundDays) params.append('partialRefundDays', data.partialRefundDays);
        if (data.partialRefundPercent) params.append('partialRefundPercent', data.partialRefundPercent);
        if (data.noRefundWithinDays) params.append('noRefundWithinDays', data.noRefundWithinDays);
        
        // Add amenities
        if (data.amenities && Array.isArray(data.amenities)) {
            data.amenities.forEach(amenityId => {
                params.append('selectedAmenities', amenityId);
            });
        }
        
        // Store images in sessionStorage for retrieval after reload
        if (data.hotelImage || (data.roomImages && data.roomImages.length > 0)) {
            const imageData = {
                hotelImage: data.hotelImage,
                roomImages: data.roomImages
            };
            sessionStorage.setItem('draftImages', JSON.stringify(imageData));
        }
        
        // Show loading message
        showSuccessNotification('Đang tải nháp...', 'Trang sẽ được tải lại với dữ liệu từ nháp.');
        
        // Redirect to the same page with parameters
        setTimeout(() => {
            window.location.href = '/register-host?' + params.toString();
        }, 500);
    }
    
    // Delete draft from localStorage
    function deleteDraftFromLocalStorage(draftId) {
        try {
            const drafts = getDraftsFromStorage();
            const draftToDelete = drafts.find(d => d.id === draftId);
            const updatedDrafts = drafts.filter(d => d.id !== draftId);
            
            localStorage.setItem(DRAFT_STORAGE_KEY, JSON.stringify(updatedDrafts));
            
            showSuccessNotification('Xóa nháp thành công!', `Đã xóa nháp "${draftToDelete ? draftToDelete.name : 'không xác định'}"`);
            loadDraftsList();
            
        } catch (error) {
            console.error('Error deleting draft:', error);
            showErrorNotification('Lỗi xóa nháp!', 'Không thể xóa nháp');
        }
    }
    
    // Clear all drafts (utility function)
    function clearAllDrafts() {
        if (confirm('Bạn có chắc chắn muốn xóa TẤT CẢ bản nháp đã lưu?')) {
            localStorage.removeItem(DRAFT_STORAGE_KEY);
            loadDraftsList();
            showSuccessNotification('Xóa tất cả nháp!', 'Đã xóa tất cả bản nháp đã lưu');
        }
    }
</script>

</body>
</html>