<!-- moderatorUserList.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hamora - Quản Lý Người Dùng</title>

    <!-- Meta Tags -->
    <meta name="author" content="Đội Ngũ Hamora">
    <meta name="description" content="Hamora - Trang Quản Lý Người Dùng">

    <!-- Dark mode -->
    <script>
        const storedTheme = localStorage.getItem('theme')

        const getPreferredTheme = () => {
            if (storedTheme) {
                return storedTheme
            }
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
        }

        const setTheme = function (theme) {
            if (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.setAttribute('data-bs-theme', 'dark')
            } else {
                document.documentElement.setAttribute('data-bs-theme', theme)
            }
        }

        setTheme(getPreferredTheme())

        window.addEventListener('DOMContentLoaded', () => {
            var el = document.querySelector('.theme-icon-active');
            if(el != 'undefined' && el != null) {
                const showActiveTheme = theme => {
                    const activeThemeIcon = document.querySelector('.theme-icon-active use')
                    const btnToActive = document.querySelector(`[data-bs-theme-value="${theme}"]`)
                    const svgOfActiveBtn = btnToActive.querySelector('.mode-switch use').getAttribute('href')

                    document.querySelectorAll('[data-bs-theme-value]').forEach(element => {
                        element.classList.remove('active')
                    })

                    btnToActive.classList.add('active')
                    activeThemeIcon.setAttribute('href', svgOfActiveBtn)
                }

                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                    if (storedTheme !== 'light' || storedTheme !== 'dark') {
                        setTheme(getPreferredTheme())
                    }
                })

                showActiveTheme(getPreferredTheme())

                document.querySelectorAll('[data-bs-theme-value]')
                    .forEach(toggle => {
                        toggle.addEventListener('click', () => {
                            const theme = toggle.getAttribute('data-bs-theme-value')
                            localStorage.setItem('theme', theme)
                            setTheme(theme)
                            showActiveTheme(theme)
                        })
                    })

            }
        })

    </script>

    <!-- Favicon -->
    <link rel="shortcut icon" th:href="@{/assets/images/favicon.ico}">

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&amp;family=Poppins:wght@400;500;700&amp;display=swap">

    <!-- Plugins CSS -->
    <link rel="stylesheet" th:href="@{/assets/vendor/font-awesome/css/all.min.css}">
    <link rel="stylesheet" th:href="@{/assets/vendor/bootstrap-icons/bootstrap-icons.css}">

    <!-- Theme CSS -->
    <link rel="stylesheet" th:href="@{/assets/css/style.css}">

    <style>
      [data-bs-theme="dark"] .page-link {
          background-color: #2b3035;
          color: #dee2e6;
          border-color: #495057;
      }

      [data-bs-theme="dark"] .page-link:hover {
          background-color: #343a40;
          color: #fff;
          border-color: #495057;
      }

      [data-bs-theme="dark"] .page-item.active .page-link {
          background-color: #5143d9;
          border-color: #5143d9;
          color: #fff;
      }

      [data-bs-theme="dark"] .page-item.disabled .page-link {
          background-color: #212529;
          color: #6c757d;
          border-color: #495057;
      }
    </style>

</head>
<body>
<main>
    <!-- Sidebar START -->
    <div th:replace="~{common-moderator/moderator-slidebar :: moderator_sidebar}"></div>
    <!-- Sidebar END -->

    <!-- Page content START -->
    <div class="page-content">

        <!-- Top bar START -->
        <div th:replace="~{common-admin/admin-topbar :: admin_topbar}"></div>
        <!-- Top bar END -->

        <div class="page-content-wrapper p-xxl-4">
            <!-- Title and stats START -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-sm-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 mb-2 mb-sm-0">Quản Lý Người Dùng</h1>
                            <p class="text-muted mb-0">Xem, quản lý và báo cáo người dùng trong hệ thống.</p>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class.badge.bg-success.me-2 th:text="${#lists.size(users)} + ' Tổng'"></span>
                            <span class="badge bg-success me-2" th:text="${activeUsers} + ' Hoạt động'"></span>
                            <span class="badge bg-warning me-2" th:text="${lockedUsers} + ' Bị khóa'"></span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Title and stats END -->

            <!-- Filters and search START -->
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                                        <input type="text" class="form-control" id="searchInput"
                                               placeholder="Tìm theo tên hoặc email...">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="roleFilter">
                                        <option value="">Tất cả vai trò</option>
                                        <option value="customer">Khách hàng</option>
                                        <option value="host">Chủ khách sạn</option>
                                        <option value="moderator">Quản lý viên</option>
                                        <option value="admin">Quản trị viên</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="statusFilter">
                                        <option value="">Tất cả trạng thái</option>
                                        <option value="active">Hoạt động</option>
                                        <option value="inactive">Bị khóa</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-primary w-100" id="filterBtn">
                                        <i class="bi bi-funnel me-1"></i>Lọc
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Filters and search END -->

            <!-- User list START -->
            <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-4" id="userGrid">
                <!-- User cards will be injected here by JavaScript -->
            </div>
            <!-- User list END -->

            <!-- Pagination START -->
            <div class="row mt-4">
                <div class="col-12">
                    <nav aria-label="User pagination">
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- Pagination links will be injected here by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
            <!-- Pagination END -->
        </div>
    </div>
</main>

<!-- User Detail Modal -->
<div class="modal fade" id="user-detail-modal" tabindex="-1" aria-labelledby="userDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userDetailModalLabel">Chi tiết người dùng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div class="avatar avatar-xxl">
                        <img id="detail-avatar" class="avatar-img rounded-circle" src="" alt="avatar">
                    </div>
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between">
                        <strong>Họ và tên:</strong>
                        <span id="detail-fullName"></span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <strong>Email:</strong>
                        <span id="detail-email"></span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <strong>Số điện thoại:</strong>
                        <span id="detail-phone"></span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <strong>Vai trò:</strong>
                        <span id="detail-role"></span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <strong>Trạng thái:</strong>
                        <span id="detail-status"></span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <strong>Giới tính:</strong>
                        <span id="detail-gender"></span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <strong>Ngày sinh:</strong>
                        <span id="detail-dob"></span>
                    </li>
                    <li class="list-group-item">
                        <strong>Bio:</strong>
                        <p id="detail-bio" class="mt-1 mb-0"></p>
                    </li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Flag User Modal -->
<div class="modal fade" id="flag-user-modal" tabindex="-1" aria-labelledby="flagUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="flagUserModalLabel">Báo cáo người dùng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Vui lòng cung cấp lý do báo cáo người dùng <strong id="flag-user-name"></strong>:</p>
                <textarea id="flag-reason" class="form-control" rows="3" placeholder="Ví dụ: Lạm dụng hệ thống, bình luận không phù hợp..."></textarea>
                <div class="text-danger mt-2 d-none" id="reason-error">Vui lòng nhập lý do.</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirm-flag-btn">Báo cáo</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1055">
    <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toast-title">Thông báo</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-body"></div>
    </div>
</div>


<script th:src="@{/assets/vendor/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const users = /*[[${users}]]*/ [];
        const userGrid = document.getElementById('userGrid');
        const paginationContainer = document.getElementById('pagination');
        const searchInput = document.getElementById('searchInput');
        const roleFilter = document.getElementById('roleFilter');
        const statusFilter = document.getElementById('statusFilter');
        const filterBtn = document.getElementById('filterBtn');

        const userDetailModal = new bootstrap.Modal(document.getElementById('user-detail-modal'));
        const flagUserModal = new bootstrap.Modal(document.getElementById('flag-user-modal'));
        const notificationToast = new bootstrap.Toast(document.getElementById('notificationToast'));

        let currentPage = 1;
        const itemsPerPage = 8;
        let filteredUsers = users;
        let currentUserIdToFlag = null;

        function displayUsers(page) {
            userGrid.innerHTML = '';
            page = page < 1 ? 1 : page;
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedUsers = filteredUsers.slice(start, end);

            paginatedUsers.forEach(user => {
                const userCard = `
                    <div class="col user-card">
                        <div class="card shadow h-100">
                            <div class="card-body text-center">
                                <div class="avatar avatar-xl mx-auto mb-3">
                                    <img class="avatar-img rounded-circle"
                                         src="${user.avatarUrl || '/assets/images/avatar/01.jpg'}"
                                         alt="avatar"
                                         style="${!user.active ? 'filter: grayscale(100%);' : ''}">
                                </div>
                                <h5 class="card-title mb-1">${user.fullName}</h5>
                                <p class="card-text text-muted small">${user.email}</p>
                                ${getStatusBadge(user)}
                            </div>
                            <div class="card-footer text-center">
                                 <button class="btn btn-sm btn-outline-info" onclick="openUserDetailsModal('${user.id}')"><i class="bi bi-eye me-1"></i>Xem chi tiết</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="openFlagModal('${user.id}', '${user.fullName}')"><i class="bi bi-flag me-1"></i>Báo cáo</button>
                            </div>
                        </div>
                    </div>`;
                userGrid.innerHTML += userCard;
            });
        }

        function getStatusBadge(user) {
            if (!user.active) {
                return '<span class="badge bg-warning bg-opacity-10 text-warning mb-3">Đã bị khóa</span>';
            }
            const role = (user.role || 'CUSTOMER').toUpperCase();
            switch (role) {
                case 'HOTEL_OWNER':
                    return '<span class="badge bg-info bg-opacity-10 text-info mb-3">Chủ khách sạn</span>';
                case 'MODERATOR':
                    return '<span class="badge bg-primary bg-opacity-10 text-primary mb-3">Quản lý viên</span>';
                case 'ADMIN':
                    return '<span class="badge bg-secondary bg-opacity-10 text-secondary mb-3">Quản trị viên</span>';
                default:
                    return '<span class="badge bg-success bg-opacity-10 text-success mb-3">Khách hàng</span>';
            }
        }

        function setupPagination() {
            paginationContainer.innerHTML = '';
            const pageCount = Math.ceil(filteredUsers.length / itemsPerPage);

            if (pageCount <= 1) return;

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            const prevA = document.createElement('a');
            prevA.className = 'page-link';
            prevA.href = '#';
            prevA.innerHTML = '<i class="bi bi-chevron-left"></i>';
            prevA.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    displayUsers(currentPage);
                    setupPagination();
                }
            });
            prevLi.appendChild(prevA);
            paginationContainer.appendChild(prevLi);

            // Page numbers
            for (let i = 1; i <= pageCount; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.textContent = i;
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentPage = i;
                    displayUsers(currentPage);
                    setupPagination();
                });
                li.appendChild(a);
                paginationContainer.appendChild(li);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === pageCount ? 'disabled' : ''}`;
            const nextA = document.createElement('a');
            nextA.className = 'page-link';
            nextA.href = '#';
            nextA.innerHTML = '<i class="bi bi-chevron-right"></i>';
            nextA.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage < pageCount) {
                    currentPage++;
                    displayUsers(currentPage);
                    setupPagination();
                }
            });
            nextLi.appendChild(nextA);
            paginationContainer.appendChild(nextLi);
        }

        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase();
            const role = roleFilter.value;
            const status = statusFilter.value;

            filteredUsers = users.filter(user => {
                const nameMatch = user.fullName && user.fullName.toLowerCase().includes(searchTerm);
                const emailMatch = user.email && user.email.toLowerCase().includes(searchTerm);
                const roleMatch = !role || (user.role && user.role.toLowerCase().replace('_', '') === role) || (role === 'customer' && !user.role);
                const statusMatch = !status || (status === 'active' && user.active) || (status === 'inactive' && !user.active);

                return (nameMatch || emailMatch) && roleMatch && statusMatch;
            });

            currentPage = 1;
            displayUsers(currentPage);
            setupPagination();
        }

        filterBtn.addEventListener('click', applyFilters);
        searchInput.addEventListener('input', applyFilters);

        window.openUserDetailsModal = function (userId) {
            const user = users.find(u => u.id == userId);
            if (!user) return;

            document.getElementById('detail-avatar').src = user.avatarUrl || '/assets/images/avatar/01.jpg';
            document.getElementById('detail-fullName').textContent = user.fullName || 'N/A';
            document.getElementById('detail-email').textContent = user.email || 'N/A';
            document.getElementById('detail-phone').textContent = user.phone || 'N/A';

            const role = (user.role || 'CUSTOMER').toUpperCase();
            let roleText = 'Khách hàng';
            switch (role) {
                case 'HOTEL_OWNER':
                    roleText = 'Chủ khách sạn';
                    break;
                case 'MODERATOR':
                    roleText = 'Quản lý viên';
                    break;
                case 'ADMIN':
                    roleText = 'Quản trị viên';
                    break;
            }
            document.getElementById('detail-role').textContent = roleText;
            document.getElementById('detail-status').innerHTML = user.active
                ? '<span class="badge bg-success">Hoạt động</span>'
                : '<span class="badge bg-danger">Bị khóa</span>';

            document.getElementById('detail-gender').textContent = user.gender || 'N/A';
            document.getElementById('detail-dob').textContent = user.dob ? new Date(user.dob).toLocaleDateString('vi-VN') : 'N/A';
            document.getElementById('detail-bio').textContent = user.bio || 'Không có thông tin.';

            userDetailModal.show();
        };

        window.openFlagModal = function (userId, userName) {
            currentUserIdToFlag = userId;
            document.getElementById('flag-user-name').textContent = userName;
            document.getElementById('flag-reason').value = '';
            document.getElementById('reason-error').classList.add('d-none');
            flagUserModal.show();
        };

        document.getElementById('confirm-flag-btn').addEventListener('click', function () {
            const reason = document.getElementById('flag-reason').value.trim();
            if (!reason) {
                document.getElementById('reason-error').classList.remove('d-none');
                return;
            }
            console.log(`Flagging user ${currentUserIdToFlag} for reason: ${reason}`);
            showToast('Thành công', 'Yêu cầu báo cáo đã được gửi tới quản trị viên.', true);
            flagUserModal.hide();
        });


        function showToast(title, body, isSuccess) {
            const toastTitle = document.getElementById('toast-title');
            const toastBody = document.getElementById('toast-body');
            const toastHeader = document.querySelector('#notificationToast .toast-header');

            toastTitle.textContent = title;
            toastBody.textContent = body;

            toastHeader.classList.remove('bg-success', 'bg-danger', 'text-white');
            if (isSuccess) {
                toastHeader.classList.add('bg-success', 'text-white');
            } else {
                toastHeader.classList.add('bg-danger', 'text-white');
            }
            notificationToast.show();
        }

        // Initial display
        applyFilters();
    });
</script>

</body>
</html>
