<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Th√™m Th√¥ng Tin Ph√≤ng - Booking</title>

    <!-- Meta Tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="author" content="StackBros">
    <meta name="description" content="Cung c·∫•p chi ti·∫øt v·ªÅ lo·∫°i ph√≤ng b·∫°n mu·ªën th√™m.">

    <!-- Dark mode -->
    <script>
        const storedTheme = localStorage.getItem('theme')

        const getPreferredTheme = () => {
            if (storedTheme) {
                return storedTheme
            }
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
        }

        const setTheme = function (theme) {
            if (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.setAttribute('data-bs-theme', 'dark')
            } else {
                document.documentElement.setAttribute('data-bs-theme', theme)
            }
        }

        setTheme(getPreferredTheme())

        window.addEventListener('DOMContentLoaded', () => {
            const el = document.querySelector('.theme-icon-active');
            if (el !== undefined && el !== null) {
                const showActiveTheme = theme => {
                    const activeThemeIcon = document.querySelector('.theme-icon-active use');
                    const btnToActive = document.querySelector(`[data-bs-theme-value="${theme}"]`);
                    const svgOfActiveBtn = btnToActive.querySelector('.mode-switch use').getAttribute('href');

                    document.querySelectorAll('[data-bs-theme-value]').forEach(element => {
                        element.classList.remove('active');
                    });

                    btnToActive.classList.add('active');
                    activeThemeIcon.setAttribute('href', svgOfActiveBtn);
                }

                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                    if (storedTheme !== 'light' && storedTheme !== 'dark') {
                        setTheme(getPreferredTheme());
                    }
                });

                showActiveTheme(getPreferredTheme());

                document.querySelectorAll('[data-bs-theme-value]')
                    .forEach(toggle => {
                        toggle.addEventListener('click', () => {
                            const theme = toggle.getAttribute('data-bs-theme-value');
                            localStorage.setItem('theme', theme);
                            setTheme(theme);
                            showActiveTheme(theme);
                        });
                    });
            }
        });
    </script>

    <!-- Favicon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico" th:href="@{/assets/images/favicon.ico}">

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Poppins:wght@400;500;700&display=swap">

    <!-- Plugins CSS -->
    <link rel="stylesheet" type="text/css" href="/assets/vendor/font-awesome/css/all.min.css"
          th:href="@{/assets/vendor/font-awesome/css/all.min.css}">
    <link rel="stylesheet" type="text/css" href="/assets/vendor/bootstrap-icons/bootstrap-icons.css"
          th:href="@{/assets/vendor/bootstrap-icons/bootstrap-icons.css}">
    <link rel="stylesheet" type="text/css" href="/assets/vendor/choices/css/choices.min.css"
          th:href="@{/assets/vendor/choices/css/choices.min.css}">
    <link rel="stylesheet" type="text/css" href="/assets/vendor/quill/css/quill.snow.css"
          th:href="@{/assets/vendor/quill/css/quill.snow.css}">
    <link rel="stylesheet" type="text/css" href="/assets/vendor/dropzone/css/dropzone.css"
          th:href="@{/assets/vendor/dropzone/css/dropzone.css}">


    <!-- Theme CSS -->
    <link rel="stylesheet" type="text/css" href="/assets/css/style.css" th:href="@{/assets/css/style.css}">

    <style>
        /* Enhanced form validation styles */
        .form-control.is-invalid,
        .form-select.is-invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        .form-control.is-valid,
        .form-select.is-valid {
            border-color: #198754;
            box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
        }

        .invalid-feedback {
            display: block;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875em;
            color: #dc3545;
            font-weight: 500;
        }

        .valid-feedback {
            display: block;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875em;
            color: #198754;
        }

        /* Checkbox validation styling */
        .form-check-input.is-invalid {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }

        .form-check-input.is-valid {
            border-color: #198754 !important;
            box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25) !important;
        }

        /* File input validation styling */
        .form-control[type="file"].is-invalid {
            border-color: #dc3545;
            background-color: rgba(220, 53, 69, 0.05);
        }

        .form-control[type="file"].is-valid {
            border-color: #198754;
            background-color: rgba(25, 135, 84, 0.05);
        }

        /* Choices.js dropdown validation styling */
        .choices.is-invalid .choices__inner {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }

        .choices.is-valid .choices__inner {
            border-color: #198754 !important;
            box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25) !important;
        }

        /* Validation for dropzone areas */
        .dropzone.is-invalid {
            border-color: #dc3545 !important;
            background-color: rgba(220, 53, 69, 0.05);
        }

        .dropzone.is-valid {
            border-color: #198754 !important;
            background-color: rgba(25, 135, 84, 0.05);
        }

        /* Error animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.6s ease-in-out;
        }

        /* Enhanced shake animation */
        @keyframes shake-enhanced {
            0%, 100% { transform: translateX(0) scale(1); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px) scale(1.02); }
            20%, 40%, 60%, 80% { transform: translateX(8px) scale(1.02); }
        }

        .shake-enhanced {
            animation: shake-enhanced 0.8s ease-in-out;
        }

        /* Focus highlight for invalid fields */
        .focus-highlight {
            box-shadow: 0 0 0 0.3rem rgba(220, 53, 69, 0.4) !important;
            border-color: #dc3545 !important;
            position: relative;
        }

        .focus-highlight::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #dc3545, transparent, #dc3545);
            border-radius: 6px;
            z-index: -1;
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 0.3; }
        }

        /* Notification system styles - Enhanced elegant version */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 420px;
            pointer-events: none;
        }

        .notification {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: none;
            border-radius: 12px;
            padding: 18px 24px;
            margin-bottom: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 2px 6px rgba(0, 0, 0, 0.08);
            transform: translateX(120%) scale(0.8);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            pointer-events: auto;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .notification::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, currentColor, transparent);
            opacity: 0.8;
        }

        .notification.show {
            transform: translateX(0) scale(1);
        }

        .notification.error {
            border-left: 5px solid #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
            color: #dc3545;
        }

        .notification.error::before {
            background: linear-gradient(90deg, transparent, #dc3545, transparent);
        }

        .notification.success {
            border-left: 5px solid #198754;
            background: linear-gradient(135deg, #f0fff4 0%, #ffffff 100%);
            color: #198754;
        }

        .notification.success::before {
            background: linear-gradient(90deg, transparent, #198754, transparent);
        }

        .notification.warning {
            border-left: 5px solid #ffc107;
            background: linear-gradient(135deg, #fffbf0 0%, #ffffff 100%);
            color: #ffc107;
        }

        .notification.warning::before {
            background: linear-gradient(90deg, transparent, #ffc107, transparent);
        }

        .notification .notification-content {
            flex: 1;
            margin-right: 12px;
        }

        .notification .notification-icon {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            margin-top: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 14px;
            font-weight: bold;
        }

        .notification.error .notification-icon {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

        .notification.success .notification-icon {
            background: rgba(25, 135, 84, 0.1);
            color: #198754;
        }

        .notification.warning .notification-icon {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }

        .notification .notification-title {
            font-weight: 700;
            margin-bottom: 6px;
            font-size: 15px;
            line-height: 1.2;
            display: flex;
            align-items: center;
        }

        .notification .notification-message {
            font-size: 13px;
            color: #6c757d;
            line-height: 1.5;
            font-weight: 400;
        }

        .notification.error .notification-title {
            color: #dc3545;
        }

        .notification.success .notification-title {
            color: #198754;
        }

        .notification.warning .notification-title {
            color: #ffc107;
        }

        .notification .notification-close {
            background: rgba(108, 117, 125, 0.1);
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #6c757d;
            cursor: pointer;
            padding: 0;
            margin-left: 8px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .notification .notification-close:hover {
            background: rgba(108, 117, 125, 0.2);
            color: #495057;
            transform: scale(1.1);
        }

        .notification .notification-close:active {
            transform: scale(0.95);
        }

        /* Animation for notification removal */
        .notification.removing {
            transform: translateX(120%) scale(0.8);
            opacity: 0;
        }

        /* Progress bar for auto-dismiss */
        .notification .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 2px;
            background: currentColor;
            opacity: 0.3;
            transform-origin: left center;
            animation: notificationProgress linear forwards;
        }

        @keyframes notificationProgress {
            from {
                transform: scaleX(1);
            }
            to {
                transform: scaleX(0);
            }
        }

        /* Hover effects */
        .notification:hover {
            transform: translateX(-8px) scale(1.02);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15), 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .notification:hover .notification-progress {
            animation-play-state: paused;
        }

        /* Mobile responsive */
        @media (max-width: 480px) {
            .notification-container {
                right: 16px;
                left: 16px;
                max-width: none;
            }

            .notification {
                padding: 16px 20px;
                margin-bottom: 10px;
            }

            .notification .notification-title {
                font-size: 14px;
            }

            .notification .notification-message {
                font-size: 12px;
            }
        }

        /* Amenity section validation styling */
        .amenity-section.is-invalid {
            border: 2px solid #dc3545 !important;
            border-radius: 8px;
            padding: 15px;
            background-color: rgba(220, 53, 69, 0.05);
        }

        .amenity-section.is-valid {
            border: 2px solid #198754 !important;
            border-radius: 8px;
            padding: 15px;
            background-color: rgba(25, 135, 84, 0.05);
        }
    </style>

</head>

<body>

<!-- Notification Container -->
<div class="notification-container" id="notificationContainer"></div>

<!-- Header START -->
<div th:replace="~{common/header :: header}"></div>
<!-- Header END -->

<!-- **************** MAIN CONTENT START **************** -->
<main>

    <!-- =======================
    Page Banner START -->
    <section class="pt-4 pt-md-5 pb-0">
        <div class="container">
            <div class="row">
                <div class="col-12 text-center">
                    <h1 class="fs-2 mb-2">Th√™m Th√¥ng Tin Ph√≤ng M·ªõi</h1>
                    <p class="mb-0">Cung c·∫•p c√°c chi ti·∫øt c·∫ßn thi·∫øt cho lo·∫°i ph√≤ng b·∫°n mu·ªën ƒëƒÉng k√Ω.</p>
                </div>
            </div>
        </div>
    </section>
    <!-- =======================
    Page Banner END -->

    <!-- =======================
    Add Room Form START -->
    <section>
        <div class="container">
            <div class="row">
                <div class="col-lg-10 mx-auto">
                    <!-- Form START -->
                    <form th:action="@{/add-room}" method="POST" enctype="multipart/form-data"
                          id="roomForm" novalidate>
                        <!-- If adding to an existing hotel, ensure hotelId is passed and included -->
                        <input type="hidden" name="hotelId" th:value="${hotelId}"/>

                        <div class="vstack gap-4">
                            <h4 class="mb-0">Chi Ti·∫øt Lo·∫°i Ph√≤ng</h4>

                            <!-- Room Details -->
                            <div class="card shadow">
                                <div class="card-header border-bottom">
                                    <h5 class="mb-0">Th√¥ng Tin Lo·∫°i Ph√≤ng</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="roomCategory" class="form-label">Lo·∫°i ph√≤ng (H·∫°ng ph√≤ng) *</label>
                                            <select name="roomTypeId" required class="form-select js-choice"
                                                    id="roomCategory">
                                                <option value="">Ch·ªçn lo·∫°i ph√≤ng</option>
                                                <option th:each="type : ${session.roomTypes}"
                                                        th:value="${type.roomTypeId}"
                                                        th:text="${type.name}">
                                                </option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="roomTitle" class="form-label">T√™n/Ti√™u ƒë·ªÅ ph√≤ng *</label>
                                            <input type="text" class="form-control"
                                                   placeholder="V√≠ d·ª•: Ph√≤ng Standard gi∆∞·ªùng ƒë√¥i h∆∞·ªõng ph·ªë"
                                                   name="roomTitle" id="roomTitle" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="roomMaxGuests" class="form-label">S·ªë kh√°ch t·ªëi ƒëa / ph√≤ng *</label>
                                            <input name="roomMaxGuests" type="number" class="form-control"
                                                   placeholder="S·ªë l∆∞·ª£ng kh√°ch"
                                                   min="1" id="roomMaxGuests" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="roomQuantity" class="form-label">S·ªë l∆∞·ª£ng ph√≤ng lo·∫°i n√†y *</label>
                                            <input type="number" class="form-control" placeholder="S·ªë l∆∞·ª£ng" min="1"
                                                   name="roomQuantity" id="roomQuantity" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="roomPrice" class="form-label">Gi√° m·ªói ƒë√™m (VND) *</label>
                                            <input type="number" class="form-control" placeholder="Gi√° ph√≤ng"
                                                   name="roomPrice" min="0" id="roomPrice" required>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label" for="roomDescription">M√¥ t·∫£ chi ti·∫øt v·ªÅ lo·∫°i
                                                ph√≤ng n√†y *</label>
                                            <textarea id="roomDescription" name="roomDescription"
                                                      class="form-control" rows="5" required
                                                      placeholder="M√¥ t·∫£ v·ªÅ k√≠ch th∆∞·ªõc ph√≤ng, lo·∫°i gi∆∞·ªùng, t·∫ßm nh√¨n, v√† c√°c ƒë·∫∑c ƒëi·ªÉm n·ªïi b·∫≠t kh√°c."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Room Amenities -->
                            <div class="card shadow">
                                <div class="card-header border-bottom">
                                    <h5 class="mb-0">Ti·ªán Nghi Ph√≤ng</h5>
                                </div>
                                <div class="card-body">
                                    <label class="form-label mb-3">Ch·ªçn c√°c ti·ªán nghi c√≥ trong lo·∫°i ph√≤ng
                                        n√†y:</label>
                                    <div id="amenitiesContainer" th:if="${groupedAmenities != null and !groupedAmenities.isEmpty()}">
                                        <div th:each="entry : ${groupedAmenities}">
                                            <h6 class="fw-bold mb-2" th:text="${entry.key}">T√™n danh m·ª•c</h6>
                                            <div class="row">
                                                <div class="col-sm-6 col-md-4" th:each="amenity : ${entry.value}">
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input"
                                                               type="checkbox"
                                                               th:id="'amenity-' + ${amenity.amenityId}"
                                                               th:name="amenities"
                                                               th:value="${amenity.amenityId}"/>
                                                        <label class="form-check-label"
                                                               th:for="'amenity-' + ${amenity.amenityId}"
                                                               th:text="${amenity.name}"></label>
                                                    </div>
                                                </div>
                                            </div>
                                            <hr class="my-3"/>
                                        </div>
                                    </div>
                                    <div th:unless="${groupedAmenities != null and !groupedAmenities.isEmpty()}">
                                        <p>Kh√¥ng c√≥ ti·ªán nghi n√†o ƒë∆∞·ª£c c·∫•u h√¨nh.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Room Photos -->
                            <div class="card shadow">
                                <div class="card-header border-bottom">
                                    <h5 class="mb-0">H√¨nh ·∫¢nh Lo·∫°i Ph√≤ng</h5>
                                </div>
                                <div class="card-body">
                                    <label class="form-label">T·∫£i l√™n h√¨nh ·∫£nh cho lo·∫°i ph√≤ng n√†y (t·ª´ 3 ƒë·∫øn 5 ·∫£nh) *</label>
                                    <div class="dropzone dropzone-custom mb-3"
                                         data-dropzone='{"maxFiles": 5, "addRemoveLinks": true, "acceptedFiles": "image/*"}'
                                         id="roomImagesDropzone">
                                        <div class="dz-message needsclick">
                                            <i class="bi bi-images display-3"></i>
                                            <p>K√©o th·∫£ t·ªáp v√†o ƒë√¢y ho·∫∑c nh·∫•p ƒë·ªÉ t·∫£i l√™n.</p>
                                            <p><small class="text-muted">T·ªëi thi·ªÉu 3 ·∫£nh, t·ªëi ƒëa 5 ·∫£nh</small></p>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <label for="roomImageUpload" class="form-label">Ho·∫∑c ch·ªçn ·∫£nh t·ª´ m√°y t√≠nh
                                            c·ªßa b·∫°n:</label>
                                        <input class="form-control" type="file" id="roomImageUpload"
                                               name="roomImageFiles" accept=".jpg,.jpeg,.png,.gif,.webp,.bmp,.tiff" multiple>
                                        <small class="form-text text-muted">Ch·ªçn t·ª´ 3-5 ·∫£nh JPG, JPEG, PNG, GIF, WEBP, BMP, TIFF.
                                            ·∫¢nh ƒë·∫ßu ti√™n s·∫Ω l√† ·∫£nh ƒë·∫°i di·ªán cho lo·∫°i ph√≤ng.</small>
                                        <div id="roomImagePreviewContainer"
                                             class="mt-3 d-flex flex-wrap gap-2"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="text-end">
                                <button type="submit" class="btn btn-primary mb-0" id="submitBtn">L∆∞u Th√¥ng Tin Ph√≤ng</button>
                            </div>
                        </div>
                    </form>
                    <!-- Form END -->
                </div>
            </div>
        </div>
    </section>
    <!-- =======================
    Add Room Form END -->

</main>
<!-- **************** MAIN CONTENT END **************** -->

<!-- =======================
Footer START -->
<div th:replace="~{common/footer :: footer}"></div>
<!-- =======================
Footer END -->

<!-- Back to top -->
<div class="back-top"></div>

<!-- Bootstrap JS -->
<script th:src="@{/assets/vendor/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
<!-- Vendors -->
<script th:src="@{/assets/vendor/choices/js/choices.min.js}"></script>
<script th:src="@{/assets/vendor/quill/js/quill.min.js}"></script>
<script th:src="@{/assets/vendor/dropzone/js/dropzone.js}"></script>
<!-- ThemeFunctions -->
<script th:src="@{/assets/js/functions.js}"></script>

<script>
    // GLOBAL VALIDATION VARIABLES
    window.roomFormValidation = {
        roomImagesCount: 0,
        currentRoomFiles: [],
        isValidationActive: false
    };

    // NOTIFICATION SYSTEM
    function showNotification(type, title, message, duration = 5000) {
        const container = document.getElementById('notificationContainer');

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;

        notification.innerHTML = `
        <div class="notification-content">
            <div class="notification-title">${title}</div>
            <div class="notification-message">${message}</div>
        </div>
        <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
    `;

        container.appendChild(notification);

        // Trigger animation
        setTimeout(() => {
            notification.classList.add('show');
        }, 100);

        // Auto remove after duration
        if (duration > 0) {
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, duration);
        }
    }

    function showErrorNotification(title, message) {
        showNotification('error', title, message, 8000);
    }

    function showSuccessNotification(title, message) {
        showNotification('success', title, message, 4000);
    }

    // VALIDATION FUNCTIONS
    function showFieldError(element, message) {
        if (!element) return;

        // Remove existing error
        removeFieldError(element);

        // Add error class
        element.classList.add('is-invalid');
        element.classList.remove('is-valid');

        // Handle Choices.js styling
        const choicesContainer = element.parentNode.querySelector('.choices');
        if (choicesContainer) {
            choicesContainer.classList.add('is-invalid');
            choicesContainer.classList.remove('is-valid');
        }

        // Add shake animation
        element.classList.add('shake');
        setTimeout(() => {
            element.classList.remove('shake');
        }, 600);

        // Create error message element
        const errorDiv = document.createElement('div');
        errorDiv.className = 'invalid-feedback';
        errorDiv.textContent = message;
        errorDiv.id = element.id + '_error';

        // Insert error message after the element or choices container
        const targetElement = choicesContainer || element;
        targetElement.parentNode.insertBefore(errorDiv, targetElement.nextSibling);
    }

    function removeFieldError(element) {
        if (!element) return;

        element.classList.remove('is-invalid');

        // Handle Choices.js styling
        const choicesContainer = element.parentNode.querySelector('.choices');
        if (choicesContainer) {
            choicesContainer.classList.remove('is-invalid');
        }

        const existingError = document.getElementById(element.id + '_error');
        if (existingError) {
            existingError.remove();
        }
    }

    function showFieldSuccess(element) {
        if (!element) return;

        removeFieldError(element);
        element.classList.add('is-valid');
        element.classList.remove('is-invalid');

        // Handle Choices.js styling
        const choicesContainer = element.parentNode.querySelector('.choices');
        if (choicesContainer) {
            choicesContainer.classList.add('is-valid');
            choicesContainer.classList.remove('is-invalid');
        }
    }

    function validateField(element) {
        if (!element) return false;

        const value = element.value ? element.value.trim() : '';

        // Check if field is required
        if (element.hasAttribute('required') && value === '') {
            showFieldError(element, 'Tr∆∞·ªùng n√†y l√† b·∫Øt bu·ªôc');
            return false;
        }

        // Specific validation for different field types
        if (element.type === 'number' && value !== '') {
            const numValue = parseFloat(value);
            if (isNaN(numValue)) {
                showFieldError(element, 'Gi√° tr·ªã ph·∫£i l√† s·ªë');
                return false;
            }

            // Specific number validation
            if (element.id === 'roomMaxGuests') {
                if (numValue < 1 || numValue > 20) {
                    showFieldError(element, 'S·ªë kh√°ch t·ªëi ƒëa ph·∫£i t·ª´ 1 ƒë·∫øn 20');
                    return false;
                }
            } else if (element.id === 'roomQuantity') {
                if (numValue < 1 || numValue > 100) {
                    showFieldError(element, 'S·ªë l∆∞·ª£ng ph√≤ng ph·∫£i t·ª´ 1 ƒë·∫øn 100');
                    return false;
                }
            } else if (element.id === 'roomPrice') {
                if (numValue < 1000 || numValue > 50000000) {
                    showFieldError(element, 'Gi√° ph√≤ng ph·∫£i t·ª´ 1,000 VND ƒë·∫øn 50,000,000 VND');
                    return false;
                }
            }
        }

        // Text length validation
        if ((element.type === 'text' || element.tagName === 'TEXTAREA') && value !== '') {
            if (element.id === 'roomTitle' && value.length < 3) {
                showFieldError(element, 'T√™n ph√≤ng ph·∫£i c√≥ √≠t nh·∫•t 3 k√Ω t·ª±');
                return false;
            } else if (element.id === 'roomDescription' && value.length < 10) {
                showFieldError(element, 'M√¥ t·∫£ ph√≤ng ph·∫£i c√≥ √≠t nh·∫•t 10 k√Ω t·ª±');
                return false;
            }
        }

        showFieldSuccess(element);
        return true;
    }

    function validateSelect(element) {
        if (!element) return false;

        const value = element.value;

        if (element.hasAttribute('required') && (value === '' || value === null || value === undefined)) {
            showFieldError(element, 'Vui l√≤ng ch·ªçn m·ªôt l·ª±a ch·ªçn');
            return false;
        }

        showFieldSuccess(element);
        return true;
    }

    function validateImages() {
        const fileInput = document.getElementById('roomImageUpload');
        const previewContainer = document.getElementById('roomImagePreviewContainer');
        const minImages = 3;
        const maxImages = 5;

        let imageCount = 0;

        // Check file input
        if (fileInput && fileInput.files.length > 0) {
            imageCount = fileInput.files.length;
        }

        // Check preview container
        if (previewContainer) {
            const previews = previewContainer.querySelectorAll('img');
            imageCount = Math.max(imageCount, previews.length);
        }

        // Check global counter
        imageCount = Math.max(imageCount, window.roomFormValidation.roomImagesCount);
        imageCount = Math.max(imageCount, window.roomFormValidation.currentRoomFiles.length);

        console.log('Image validation - count:', imageCount, 'min:', minImages, 'max:', maxImages);

        // Validate minimum images
        if (imageCount < minImages) {
            if (fileInput) {
                showFieldError(fileInput, `Vui l√≤ng t·∫£i l√™n √≠t nh·∫•t ${minImages} ·∫£nh ph√≤ng (hi·ªán t·∫°i: ${imageCount}/${maxImages})`);
            }
            return false;
        }

        // Validate maximum images
        if (imageCount > maxImages) {
            if (fileInput) {
                showFieldError(fileInput, `S·ªë l∆∞·ª£ng ·∫£nh v∆∞·ª£t qu√° gi·ªõi h·∫°n. T·ªëi ƒëa ${maxImages} ·∫£nh (hi·ªán t·∫°i: ${imageCount}/${maxImages})`);
            }
            return false;
        }

        if (fileInput) {
            showFieldSuccess(fileInput);
        }
        return true;
    }

    function validateAmenities() {
        const amenityCheckboxes = document.querySelectorAll('input[name="amenities"]:checked');
        const amenitiesContainer = document.getElementById('amenitiesContainer');
        const allAmenityCheckboxes = document.querySelectorAll('input[name="amenities"]');

        if (amenityCheckboxes.length === 0) {
            // Add error styling to container
            if (amenitiesContainer) {
                amenitiesContainer.classList.add('amenity-section', 'is-invalid');
                amenitiesContainer.classList.remove('is-valid');
            }

            // Add error styling to individual checkboxes
            allAmenityCheckboxes.forEach(checkbox => {
                checkbox.classList.add('is-invalid');
                checkbox.classList.remove('is-valid');
            });

            showErrorNotification('Thi·∫øu ti·ªán nghi!', 'Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ti·ªán nghi cho ph√≤ng.');
            return false;
        }

        // Remove error styling and add success styling
        if (amenitiesContainer) {
            amenitiesContainer.classList.remove('amenity-section', 'is-invalid');
            amenitiesContainer.classList.add('amenity-section', 'is-valid');
        }

        // Add success styling to individual checkboxes
        allAmenityCheckboxes.forEach(checkbox => {
            checkbox.classList.remove('is-invalid');
            checkbox.classList.add('is-valid');
        });

        return true;
    }

    // COMPREHENSIVE FORM VALIDATION
    function validateAllFields() {
        let isValid = true;
        let firstInvalidElement = null;
        let emptyFields = [];

        console.log('=== STARTING COMPREHENSIVE VALIDATION ===');

        // Define all required fields
        const requiredFields = [
            { id: 'roomCategory', name: 'Lo·∫°i ph√≤ng', type: 'select' },
            { id: 'roomTitle', name: 'T√™n ph√≤ng', type: 'text' },
            { id: 'roomMaxGuests', name: 'S·ªë kh√°ch t·ªëi ƒëa', type: 'number' },
            { id: 'roomQuantity', name: 'S·ªë l∆∞·ª£ng ph√≤ng', type: 'number' },
            { id: 'roomPrice', name: 'Gi√° ph√≤ng', type: 'number' },
            { id: 'roomDescription', name: 'M√¥ t·∫£ ph√≤ng', type: 'textarea' }
        ];

        // Validate each required field
        requiredFields.forEach(field => {
            const element = document.getElementById(field.id);
            console.log(`Validating ${field.id}:`, element ? element.value : 'ELEMENT NOT FOUND');

            if (!element) {
                console.error(`Element ${field.id} not found!`);
                isValid = false;
                emptyFields.push(field.name);
                return;
            }

            let fieldValid = false;

            if (field.type === 'select') {
                fieldValid = validateSelect(element);
            } else {
                fieldValid = validateField(element);
            }

            if (!fieldValid) {
                isValid = false;
                if (!firstInvalidElement) {
                    firstInvalidElement = element;
                }
                if (element.value.trim() === '') {
                    emptyFields.push(field.name);
                }
            }
        });

        // Validate images
        console.log('Validating images...');
        if (!validateImages()) {
            isValid = false;
            const imageCount = Math.max(
                window.roomFormValidation.roomImagesCount,
                window.roomFormValidation.currentRoomFiles.length
            );
            if (imageCount < 3) {
                emptyFields.push('H√¨nh ·∫£nh ph√≤ng (t·ªëi thi·ªÉu 3 ·∫£nh)');
            } else if (imageCount > 5) {
                emptyFields.push('H√¨nh ·∫£nh ph√≤ng (v∆∞·ª£t qu√° 5 ·∫£nh)');
            }
            const fileInput = document.getElementById('roomImageUpload');
            if (!firstInvalidElement && fileInput) {
                firstInvalidElement = fileInput;
            }
        }

        // Validate amenities
        console.log('Validating amenities...');
        if (!validateAmenities()) {
            isValid = false;
            emptyFields.push('Ti·ªán nghi ph√≤ng');
            const firstAmenity = document.querySelector('input[name="amenities"]');
            if (!firstInvalidElement && firstAmenity) {
                firstInvalidElement = firstAmenity;
            }
        }

        console.log('=== VALIDATION RESULTS ===');
        console.log('Is valid:', isValid);
        console.log('Empty fields:', emptyFields);
        console.log('First invalid element:', firstInvalidElement);

        // Show error notification if validation failed
        if (!isValid) {
            showErrorNotification(
                'Thi·∫øu th√¥ng tin b·∫Øt bu·ªôc!',
                `Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß: ${emptyFields.join(', ')}`
            );

            // Focus first invalid element
            if (firstInvalidElement) {
                setTimeout(() => {
                    firstInvalidElement.focus();
                    firstInvalidElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            }
        }

        return isValid;
    }

    // IMAGE UPLOAD HANDLING
    function handleFiles(files) {
        const maxImages = 5;
        let validFilesToAdd = [];
        
        files.forEach(file => {
            if (!isValidImageFile(file)) {
                showErrorNotification(
                    'ƒê·ªãnh d·∫°ng file kh√¥ng h·ªó tr·ª£',
                    `File "${file.name}" kh√¥ng ph·∫£i l√† ·∫£nh h·ª£p l·ªá. Ch·ªâ ch·∫•p nh·∫≠n: JPG, JPEG, PNG, GIF, WEBP, BMP, TIFF.`
                );
                return;
            }
            
            // Check for duplicates
            if (window.roomFormValidation.currentRoomFiles.some(f => f.name === file.name && f.size === file.size)) {
                return; // Skip duplicate files
            }
            
            // Check if we can add more files
            if (window.roomFormValidation.currentRoomFiles.length + validFilesToAdd.length < maxImages) {
                validFilesToAdd.push(file);
            }
        });
        
        // Check if we're trying to add too many files
        if (window.roomFormValidation.currentRoomFiles.length + validFilesToAdd.length > maxImages) {
            const remainingSlots = maxImages - window.roomFormValidation.currentRoomFiles.length;
            if (remainingSlots > 0) {
                validFilesToAdd = validFilesToAdd.slice(0, remainingSlots);
                showErrorNotification(
                    'Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng ·∫£nh',
                    `Ch·ªâ c√≥ th·ªÉ t·∫£i l√™n t·ªëi ƒëa ${maxImages} ·∫£nh. ƒê√£ th√™m ${remainingSlots} ·∫£nh ƒë·∫ßu ti√™n.`
                );
            } else {
                showErrorNotification(
                    'ƒê√£ ƒë·∫°t gi·ªõi h·∫°n t·ªëi ƒëa',
                    `ƒê√£ ƒë·∫°t gi·ªõi h·∫°n t·ªëi ƒëa ${maxImages} ·∫£nh. Vui l√≤ng x√≥a b·ªõt ·∫£nh hi·ªán t·∫°i tr∆∞·ªõc khi th√™m ·∫£nh m·ªõi.`
                );
                return;
            }
        }
        
        if (window.roomFormValidation.currentRoomFiles.length + files.length > maxImages) {
            const totalAttempted = window.roomFormValidation.currentRoomFiles.length + files.length;
            showErrorNotification(
                'V∆∞·ª£t qu√° gi·ªõi h·∫°n',
                `Kh√¥ng th·ªÉ th√™m t·∫•t c·∫£ ·∫£nh. B·∫°n ƒëang c·ªë th√™m ${files.length} ·∫£nh nh∆∞ng ch·ªâ c√≤n ${maxImages - window.roomFormValidation.currentRoomFiles.length} v·ªã tr√≠ tr·ªëng (t·ªëi ƒëa ${maxImages} ·∫£nh).`
            );
        }
        
        // Add valid files to the list
        window.roomFormValidation.currentRoomFiles.push(...validFilesToAdd);

        // Update counters
        window.roomFormValidation.roomImagesCount = window.roomFormValidation.currentRoomFiles.length;

        updateManualFileInput();
        renderPreviews();

        // Show success message if files were added
        if (validFilesToAdd.length > 0) {
            const successMsg = validFilesToAdd.length === 1 ? 
                `ƒê√£ th√™m 1 ·∫£nh. T·ªïng c·ªông: ${window.roomFormValidation.currentRoomFiles.length}/${maxImages} ·∫£nh.` :
                `ƒê√£ th√™m ${validFilesToAdd.length} ·∫£nh. T·ªïng c·ªông: ${window.roomFormValidation.currentRoomFiles.length}/${maxImages} ·∫£nh.`;
            
            showSuccessNotification('Th√™m ·∫£nh th√†nh c√¥ng!', successMsg);
        }

        // Validate after upload
        validateImages();
    }

    function isValidImageFile(file) {
        const validTypes = [
            "image/jpeg",
            "image/jpg",
            "image/png",
            "image/gif",
            "image/webp",
            "image/bmp",
            "image/tiff"
        ];

        const validExtensions = [
            '.jpg',
            '.jpeg',
            '.png',
            '.gif',
            '.webp',
            '.bmp',
            '.tiff'
        ];

        // Check MIME type
        const isValidMimeType = validTypes.includes(file.type.toLowerCase());

        // Check file extension as backup
        const fileName = file.name.toLowerCase();
        const isValidExtension = validExtensions.some(ext => fileName.endsWith(ext));

        return isValidMimeType || isValidExtension;
    }

    function renderPreviews() {
        const previewContainer = document.getElementById('roomImagePreviewContainer');
        if (!previewContainer) return;

        previewContainer.innerHTML = "";

        window.roomFormValidation.currentRoomFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function (e) {
                const wrapper = document.createElement("div");
                wrapper.classList.add("position-relative", "m-1", "border", "rounded", "overflow-hidden");
                wrapper.style.width = "100px";
                wrapper.style.height = "100px";

                const img = document.createElement("img");
                img.src = e.target.result;
                img.style.width = "100%";
                img.style.height = "100%";
                img.style.objectFit = "cover";

                const deleteBtn = document.createElement("button");
                deleteBtn.type = "button";
                deleteBtn.innerHTML = "√ó";
                deleteBtn.classList.add("btn", "btn-danger", "btn-sm", "position-absolute");
                deleteBtn.style.top = "2px";
                deleteBtn.style.right = "2px";
                deleteBtn.title = "X√≥a ·∫£nh";
                deleteBtn.onclick = () => {
                    window.roomFormValidation.currentRoomFiles.splice(index, 1);
                    window.roomFormValidation.roomImagesCount = window.roomFormValidation.currentRoomFiles.length;
                    updateManualFileInput();
                    renderPreviews();
                    validateImages();
                };

                // Add order indicator for first image
                if (index === 0) {
                    const orderBadge = document.createElement("span");
                    orderBadge.textContent = "·∫¢nh ƒë·∫°i di·ªán";
                    orderBadge.classList.add("badge", "bg-primary", "position-absolute");
                    orderBadge.style.bottom = "2px";
                    orderBadge.style.left = "2px";
                    orderBadge.style.fontSize = "10px";
                    wrapper.appendChild(orderBadge);
                }

                wrapper.appendChild(img);
                wrapper.appendChild(deleteBtn);
                previewContainer.appendChild(wrapper);
            };
            reader.readAsDataURL(file);
        });
    }

    function updateManualFileInput() {
        const fileInput = document.getElementById('roomImageUpload');
        if (!fileInput) return;

        const dataTransfer = new DataTransfer();
        window.roomFormValidation.currentRoomFiles.forEach(file => dataTransfer.items.add(file));
        fileInput.files = dataTransfer.files;
    }

    // MAIN INITIALIZATION
    document.addEventListener('DOMContentLoaded', function () {
        console.log('üöÄ Room form validation initializing...');

        // Initialize Choices.js
        const choiceElements = document.querySelectorAll('.js-choice');
        choiceElements.forEach(function (el) {
            new Choices(el, {
                searchEnabled: false,
                itemSelectText: 'Nh·∫•n ƒë·ªÉ ch·ªçn',
            });
        });

        // Get form reference
        const form = document.getElementById('roomForm');
        const submitBtn = document.getElementById('submitBtn');

        if (!form) {
            console.error('‚ùå Form not found!');
            return;
        }

        console.log('‚úÖ Form found:', form);

        // Set up image upload handlers
        const dropArea = document.getElementById("roomImagesDropzone");
        const manualFileInput = document.getElementById("roomImageUpload");

        if (dropArea) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            dropArea.addEventListener("dragover", (e) => {
                e.preventDefault();
                dropArea.classList.add("bg-light");
            });

            dropArea.addEventListener("dragleave", (e) => {
                e.preventDefault();
                dropArea.classList.remove("bg-light");
            });

            dropArea.addEventListener("drop", (e) => {
                e.preventDefault();
                dropArea.classList.remove("bg-light");
                handleFiles(Array.from(e.dataTransfer.files));
            });
        }

        if (manualFileInput) {
            manualFileInput.addEventListener("change", () => {
                handleFiles(Array.from(manualFileInput.files));
            });
        }

        // Set up real-time validation
        form.addEventListener('input', function(event) {
            const element = event.target;

            if (element.type === 'text' || element.type === 'number' || element.tagName === 'TEXTAREA') {
                validateField(element);
            }
        });

        form.addEventListener('change', function(event) {
            const element = event.target;

            if (element.tagName === 'SELECT') {
                validateSelect(element);
            } else if (element.type === 'file') {
                validateImages();
            } else if (element.type === 'checkbox' && element.name === 'amenities') {
                // Real-time amenity validation when any checkbox is clicked
                validateAmenities();
            }
        });

        // CRITICAL: Form submission handler with absolute validation
        form.addEventListener('submit', function(event) {
            console.log('üî• FORM SUBMISSION ATTEMPTED');

            // ALWAYS prevent the default submission first
            event.preventDefault();
            event.stopPropagation();

            console.log('‚úã Form submission blocked for validation');

            // Run comprehensive validation
            const isValid = validateAllFields();

            if (!isValid) {
                console.log('‚ùå VALIDATION FAILED - SUBMISSION BLOCKED');
                return false;
            }

            console.log('‚úÖ VALIDATION PASSED - SUBMITTING FORM');
            showSuccessNotification('ƒêang l∆∞u...', 'T·∫•t c·∫£ th√¥ng tin h·ª£p l·ªá. ƒêang x·ª≠ l√Ω...');

            // Allow form submission by creating a new form submission
            setTimeout(() => {
                console.log('üì§ Actually submitting form now...');

                // Create form data and submit manually
                const formData = new FormData(form);

                // Log what we're submitting
                console.log('Form data being submitted:');
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}:`, value);
                }

                // Submit the form by removing the event listener and triggering submit
                form.removeEventListener('submit', arguments.callee);
                form.submit();
            }, 1000);
        });

        // Also block submit button clicks as additional safety
        if (submitBtn) {
            submitBtn.addEventListener('click', function(event) {
                console.log('üéØ Submit button clicked');

                // Check if validation is ready
                if (!window.roomFormValidation.isValidationActive) {
                    console.log('‚ö†Ô∏è Validation not ready, blocking click');
                    event.preventDefault();
                    event.stopPropagation();
                    return false;
                }
            });
        }

        // Mark validation as active
        window.roomFormValidation.isValidationActive = true;

        // Clear any existing validation styling
        const amenitiesContainer = document.getElementById('amenitiesContainer');
        const allAmenityCheckboxes = document.querySelectorAll('input[name="amenities"]');

        if (amenitiesContainer) {
            amenitiesContainer.classList.remove('amenity-section', 'is-invalid', 'is-valid');
        }

        allAmenityCheckboxes.forEach(checkbox => {
            checkbox.classList.remove('is-invalid', 'is-valid');
        });

        console.log('‚úÖ Room form validation initialized successfully');
    });
</script>


</body>
</html>